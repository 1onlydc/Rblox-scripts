local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera
local Lighting = game:GetService("Lighting")
local ContextActionService = game:GetService("ContextActionService")
local Debris = game:GetService("Debris")

-- [[ GLOBAL CONFIG TABLES ]] --
_G.ConfigUpdateFunctions = {} -- Table to store functions that need to run when config loads
local ThemeUpdateFunctions = {} -- Table for theme updates

-- Check if file functions are available (Updated for new Config System)
local hasFileFunctions = pcall(function()
    return readfile and writefile and isfile and listfiles and delfile and makefolder
end)

-- Create folder if it doesn't exist
if hasFileFunctions then
    if not isfolder("NerdWare") then
        makefolder("NerdWare")
    end
end

-- COMPLETE SETTINGS WITH ALL REQUIRED FIELDS
_G.Settings = {
    Aimbot = { Enabled = false, AimPart = "Head", FOV = 100, Smoothness = 0.5, Prediction = 0.15, TeamCheck = true, Method = "CamLock", Target = "Closest" },
    TriggerBot = { Enabled = false, Delay = 0.1, ToolOnly = false },
    Visuals = {
        Enable = false, Box = false, Name = false, Health = false, Chams = false,
        Tracers = false, Fullbright = false, Distance = false, Tracer = false,
        BoxType = "3D", NameDisplay = "Nickname", TracerPosition = "Middle"
    },
    Player = { WalkSpeed = 16, JumpPower = 50, InfJump = false, Noclip = false, FlySpeed = 50 },
    Misc = { AntiAFK = false },
    Prediction = { Enabled = false, Value = 0.15 },
    Smoothness = { Enabled = true, Value = 0.5 },
    Sticky = { Enabled = false },
    ResolverCam = { Enabled = false },
    Highlights = { Enabled = false },
    Tracer = { Enabled = false },
    TeamCheck = { Enabled = true },
    WallCheck = { Enabled = false },
    KnockedCheck = { Enabled = false },
    HitboxExpander = { Enabled = false },
    HitboxTrasnparency = { Enabled = false },
    HitboxSize = { Value = 3 },
    Trasnparency = { Value = 0.5 },
    Brightness = { Enable = false },
    AvatarFF = { Enable = false },
    SpawnRate = { Value = 0.1 },
    Lifetime = { Value = 5 },
    TrailClones = { Value = 10 },
    Exposure = { Enabled = false, Value = 1 },
    Ambient = { Enabled = false },
    Fog = { Enabled = false },
    ClockTime = { Enabled = false, Value = 12 },
    Fov = { Enabled = false, Value = 100 },
    Speed = { Enable = false },
    Jump = { Enable = false },
    Fly = { Enable = false },
    InfiniteZoom = { Enable = false },
    ChatSpy = { Enable = false },
    DisableChairs = { Enable = false },
    AntiFling = { Enable = false },
    DamageNumber = { Enable = false },
    HitSound = { Enable = false, Type = "2D" },
    ExposureValue = { Value = 1 }
}

-- [[ UI LIBRARY ]] --
local Library = {}
local UIConfig = {
    Font = Enum.Font.Gotham,
    FontBold = Enum.Font.GothamBold,
    FontTitle = Enum.Font.GothamBlack,
    MainColor = Color3.fromRGB(12, 12, 12),
    SecondaryColor = Color3.fromRGB(0, 0, 0),
    SectionColor = Color3.fromRGB(14, 14, 14),
    Accent = Color3.fromRGB(100, 200, 100),
    Text = Color3.fromRGB(255, 255, 255),
    TextDim = Color3.fromRGB(255, 255, 255),
    Outline = Color3.fromRGB(40, 40, 40)
}

local function TweenObject(obj, props, duration, style, direction)
    local tweenInfo = TweenInfo.new(
        duration or 0.2,
        style or Enum.EasingStyle.Quad,
        direction or Enum.EasingDirection.Out
    )
    local tween = TweenService:Create(obj, tweenInfo, props)
    tween:Play()
    return tween
end

local function AnimateSliderFill(fill, targetSize)
    TweenObject(fill, { Size = targetSize }, 0.08, Enum.EasingStyle.Sine)
end

local function AnimateUIEntrance(mainFrame)
    mainFrame.Position = UDim2.new(0.5, -375, 0.5, -250)
    mainFrame.Size = UDim2.new(0, 0, 0, 0)
    mainFrame.Visible = true
    mainFrame.BackgroundTransparency = 1
    TweenObject(mainFrame, {
        Size = UDim2.new(0, 760, 0, 510),
        BackgroundTransparency = 0
    }, 0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
    task.delay(0.35, function()
        TweenObject(mainFrame, {
            Size = UDim2.new(0, 750, 0, 500)
        }, 0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    end)
end

function Library:Window()
    local Window = {}
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "GoldSenseUI"
    ScreenGui.Parent = game:GetService("CoreGui") or LocalPlayer:WaitForChild("PlayerGui")
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local Main = Instance.new("Frame")
    Main.Name = "Main"
    Main.Size = UDim2.new(0, 750, 0, 500)
    Main.Position = UDim2.new(0.5, -375, 0.5, -250)
    Main.BackgroundColor3 = UIConfig.MainColor
    Main.BorderSizePixel = 0
    Main.Visible = false
    Main.ClipsDescendants = true
    Main.Parent = ScreenGui

    -- Register Main frame for updates
    table.insert(ThemeUpdateFunctions, function()
        Main.BackgroundColor3 = UIConfig.MainColor
    end)

    task.spawn(function()
        wait(0.1)
        AnimateUIEntrance(Main)
    end)

    local Dragging, DragStart, StartPos
    
    Main.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            Dragging = true
            DragStart = Vector2.new(Mouse.X, Mouse.Y)
            StartPos = Main.Position
        end
    end)

    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then 
            Dragging = false 
        end
    end)
    
    RunService.RenderStepped:Connect(function()
        if Dragging then
            local CurrentMouse = Vector2.new(Mouse.X, Mouse.Y)
            local Delta = CurrentMouse - DragStart
            Main.Position = UDim2.new(StartPos.X.Scale, StartPos.X.Offset + Delta.X, StartPos.Y.Scale, StartPos.Y.Offset + Delta.Y)
        end
    end)

    local MainStroke = Instance.new("UIStroke")
    MainStroke.Color = UIConfig.Outline
    MainStroke.Thickness = 1
    MainStroke.Parent = Main

    table.insert(ThemeUpdateFunctions, function()
        MainStroke.Color = UIConfig.Outline
    end)

    local Sidebar = Instance.new("Frame")
    Sidebar.Name = "Sidebar"
    Sidebar.Size = UDim2.new(0, 180, 1, 0)
    Sidebar.Position = UDim2.new(0, 0, 0, 0)
    Sidebar.BackgroundColor3 = UIConfig.SecondaryColor
    Sidebar.BorderSizePixel = 0
    Sidebar.ZIndex = 1
    Sidebar.Parent = Main

    table.insert(ThemeUpdateFunctions, function()
        Sidebar.BackgroundColor3 = UIConfig.SecondaryColor
    end)

    local SidebarBorder = Instance.new("Frame")
    SidebarBorder.Size = UDim2.new(0, 1, 1, 0)
    SidebarBorder.Position = UDim2.new(1, 0, 0, 0)
    SidebarBorder.BackgroundColor3 = UIConfig.Outline
    SidebarBorder.BorderSizePixel = 0
    SidebarBorder.ZIndex = 1
    SidebarBorder.Parent = Sidebar

    table.insert(ThemeUpdateFunctions, function()
        SidebarBorder.BackgroundColor3 = UIConfig.Outline
    end)

    local LogoArea = Instance.new("Frame")
    LogoArea.Name = "LogoArea"
    LogoArea.Size = UDim2.new(1, 0, 0, 120)
    LogoArea.Position = UDim2.new(0, 0, 0, 0)
    LogoArea.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    LogoArea.BorderSizePixel = 0
    LogoArea.ZIndex = 1
    LogoArea.Parent = Sidebar

    local LogoIcon = Instance.new("ImageLabel")
    LogoIcon.Name = "LogoIcon"
    LogoIcon.Size = UDim2.new(0, 100, 0, 100)
    LogoIcon.Position = UDim2.new(0.5, -50, 0.5, -50)
    LogoIcon.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    LogoIcon.BorderSizePixel = 0
    LogoIcon.Image = "rbxthumb://type=Asset&id=73884793344716&w=420&h=420"
    LogoIcon.ScaleType = Enum.ScaleType.Fit
    LogoIcon.ZIndex = 1
    LogoIcon.Parent = LogoArea

    -- Global ref for theme changer
    _G.LogoIconRef = LogoIcon

    local IconCorner = Instance.new("UICorner")
    IconCorner.CornerRadius = UDim.new(0, 12)
    IconCorner.Parent = LogoIcon

    local LogoDivider = Instance.new("Frame")
    LogoDivider.Size = UDim2.new(1, -20, 0, 1)
    LogoDivider.Position = UDim2.new(0, 10, 1, -1)
    LogoDivider.BackgroundColor3 = UIConfig.Accent
    LogoDivider.BorderSizePixel = 0
    LogoDivider.ZIndex = 1
    LogoDivider.Parent = LogoArea

    table.insert(ThemeUpdateFunctions, function()
        LogoDivider.BackgroundColor3 = UIConfig.Accent
    end)

    local DividerGradient = Instance.new("UIGradient")
    DividerGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(40, 40, 40)),
        ColorSequenceKeypoint.new(0.5, UIConfig.Accent),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(40, 40, 40))
    }
    DividerGradient.Parent = LogoDivider

    table.insert(ThemeUpdateFunctions, function()
        DividerGradient.Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, Color3.fromRGB(40, 40, 40)),
            ColorSequenceKeypoint.new(0.5, UIConfig.Accent),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(40, 40, 40))
        }
    end)

    local AvatarContainer = Instance.new("Frame")
    AvatarContainer.Name = "AvatarContainer"
    AvatarContainer.Size = UDim2.new(0, 36, 0, 36)
    AvatarContainer.Position = UDim2.new(1, -46, 0, 8)
    AvatarContainer.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    AvatarContainer.BorderSizePixel = 0
    AvatarContainer.ZIndex = 10
    AvatarContainer.Parent = Main

    local AvatarCorner = Instance.new("UICorner")
    AvatarCorner.CornerRadius = UDim.new(0, 8)
    AvatarCorner.Parent = AvatarContainer

    local AvatarStroke = Instance.new("UIStroke")
    AvatarStroke.Color = UIConfig.Outline
    AvatarStroke.Thickness = 1
    AvatarStroke.Parent = AvatarContainer

    local UserAvatar = Instance.new("ImageLabel")
    UserAvatar.Name = "UserAvatar"
    UserAvatar.Size = UDim2.new(1, -6, 1, -6)
    UserAvatar.Position = UDim2.new(0, 3, 0, 3)
    UserAvatar.BackgroundTransparency = 1
    UserAvatar.ZIndex = 11
    UserAvatar.Parent = AvatarContainer

    local AvatarImageCorner = Instance.new("UICorner")
    AvatarImageCorner.CornerRadius = UDim.new(0, 6)
    AvatarImageCorner.Parent = UserAvatar

    task.spawn(function()
        local content = Players:GetUserThumbnailAsync(LocalPlayer.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size48x48)
        UserAvatar.Image = content
    end)

    local TabContainer = Instance.new("Frame")
    TabContainer.Name = "TabContainer"
    TabContainer.Size = UDim2.new(1, 0, 1, -120)
    TabContainer.Position = UDim2.new(0, 0, 0, 120)
    TabContainer.BackgroundTransparency = 1
    TabContainer.ZIndex = 2
    TabContainer.Parent = Sidebar

    local TabList = Instance.new("UIListLayout")
    TabList.SortOrder = Enum.SortOrder.LayoutOrder
    TabList.Parent = TabContainer

    local ContentArea = Instance.new("Frame")
    ContentArea.Size = UDim2.new(1, -180, 1, 0)
    ContentArea.Position = UDim2.new(0, 180, 0, 0)
    ContentArea.BackgroundTransparency = 1
    ContentArea.ClipsDescendants = true
    ContentArea.ZIndex = 2
    ContentArea.Parent = Main

    local Tabs = {}
    local CurrentTab = nil

    function Window:Tab(name)
        local Tab = {}
        local TabButtonFrame = Instance.new("Frame")
        TabButtonFrame.Size = UDim2.new(1, 0, 0, 35)
        TabButtonFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
        TabButtonFrame.BackgroundTransparency = 1
        TabButtonFrame.BorderSizePixel = 0
        TabButtonFrame.ZIndex = 2
        TabButtonFrame.Parent = TabContainer

        local Btn = Instance.new("TextButton")
        Btn.Size = UDim2.new(1, 0, 1, 0)
        Btn.BackgroundTransparency = 1
        Btn.Text = name
        Btn.Font = UIConfig.Font
        Btn.TextSize = 13
        Btn.TextColor3 = UIConfig.TextDim
        Btn.TextXAlignment = Enum.TextXAlignment.Left
        Btn.ZIndex = 2
        Btn.Parent = TabButtonFrame

        local Padding = Instance.new("UIPadding")
        Padding.PaddingLeft = UDim.new(0, 20)
        Padding.Parent = Btn

        local Indicator = Instance.new("Frame")
        Indicator.Size = UDim2.new(0, 2, 0, 18)
        Indicator.Position = UDim2.new(0, -20, 0.5, -9)
        Indicator.BackgroundColor3 = UIConfig.Accent
        Indicator.BackgroundTransparency = 1
        Indicator.BorderSizePixel = 0
        Indicator.ZIndex = 2
        Indicator.Parent = Btn

        Btn.MouseButton1Click:Connect(function()
            TweenObject(Btn, { TextTransparency = 0.3 }, 0.05)
            task.delay(0.05, function()
                TweenObject(Btn, { TextTransparency = 0 }, 0.15)
            end)
        end)

        local PageContainer = Instance.new("Frame")
        PageContainer.Size = UDim2.new(1, 0, 1, 0)
        PageContainer.BackgroundTransparency = 1
        PageContainer.Visible = false
        PageContainer.ClipsDescendants = true
        PageContainer.ZIndex = 2
        PageContainer.Parent = ContentArea

        local TopBar = Instance.new("Frame")
        TopBar.Size = UDim2.new(1, 0, 0, 50)
        TopBar.BackgroundTransparency = 1
        TopBar.ZIndex = 2
        TopBar.Parent = PageContainer

        local TopList = Instance.new("UIListLayout")
        TopList.FillDirection = Enum.FillDirection.Horizontal
        TopList.Padding = UDim.new(0, 10)
        TopList.VerticalAlignment = Enum.VerticalAlignment.Center
        TopList.Parent = TopBar

        local TopPadding = Instance.new("UIPadding")
        TopPadding.PaddingLeft = UDim.new(0, 20)
        TopPadding.Parent = TopBar

        local SubPageContainer = Instance.new("Frame")
        SubPageContainer.Size = UDim2.new(1, 0, 1, -50)
        SubPageContainer.Position = UDim2.new(0, 0, 0, 50)
        SubPageContainer.BackgroundTransparency = 1
        SubPageContainer.ClipsDescendants = true
        SubPageContainer.ZIndex = 2
        SubPageContainer.Parent = PageContainer

        local isActive = false

        table.insert(ThemeUpdateFunctions, function()
            if CurrentTab == Tab then
                TabButtonFrame.BackgroundColor3 = UIConfig.Accent
                Indicator.BackgroundColor3 = UIConfig.Accent
                Btn.TextColor3 = UIConfig.Text
            else
                Btn.TextColor3 = UIConfig.TextDim
            end
        end)

        Btn.MouseButton1Click:Connect(function()
            if CurrentTab == Tab then return end
            for _, t in pairs(Tabs) do
                if t.PageContainer.Visible and t ~= Tab then
                    t.isActive = false
                    TweenObject(t.Btn, { TextColor3 = UIConfig.TextDim }, 0.2)
                    TweenObject(t.TabButtonFrame, { BackgroundColor3 = Color3.fromRGB(25, 25, 25), BackgroundTransparency = 1 }, 0.2)
                    TweenObject(t.Indicator, { BackgroundTransparency = 1, Size = UDim2.new(0, 2, 0, 0) }, 0.2)
                    t.PageContainer.Visible = false
                end
            end

            isActive = true
            TweenObject(Btn, { TextColor3 = UIConfig.Text }, 0.2)
            TweenObject(TabButtonFrame, { BackgroundColor3 = UIConfig.Accent, BackgroundTransparency = 0.7 }, 0.2)
            Indicator.Size = UDim2.new(0, 2, 0, 0)
            Indicator.BackgroundTransparency = 0
            Indicator.BackgroundColor3 = UIConfig.Accent
            TweenObject(Indicator, { Size = UDim2.new(0, 2, 0, 18) }, 0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out)

            PageContainer.Visible = true
            CurrentTab = Tab
            
            if Tab.SubTabs and #Tab.SubTabs > 0 then
                local firstSub = Tab.SubTabs[1]
                if firstSub then
                    firstSub.SubPage.Visible = true
                end
            end
        end)

        table.insert(Tabs, {
            Btn = Btn,
            TabButtonFrame = TabButtonFrame,
            Indicator = Indicator,
            PageContainer = PageContainer,
            Tab = Tab,
            isActive = isActive
        })

        if #Tabs == 1 then
            isActive = true
            Btn.TextColor3 = UIConfig.Text
            TabButtonFrame.BackgroundColor3 = UIConfig.Accent
            TabButtonFrame.BackgroundTransparency = 0.7
            Indicator.BackgroundTransparency = 0
            PageContainer.Visible = true
            CurrentTab = Tab
        end

        Tab.SubTabs = {}
        Tab.PageContainer = PageContainer

        function Tab:SubTab(subName)
            local SubTab = {}
            SubTab.Elements = {}

            local SubBtn = Instance.new("TextButton")
            SubBtn.Size = UDim2.new(0, 90, 0, 30)
            SubBtn.BackgroundColor3 = UIConfig.SecondaryColor
            SubBtn.Text = subName
            SubBtn.TextColor3 = UIConfig.TextDim
            SubBtn.Font = UIConfig.Font
            SubBtn.TextSize = 12
            SubBtn.BorderSizePixel = 0
            SubBtn.ZIndex = 2
            SubBtn.Parent = TopBar

            local SubStroke = Instance.new("UIStroke")
            SubStroke.Color = UIConfig.Outline
            SubStroke.Parent = SubBtn

            local Indicator = Instance.new("Frame")
            Indicator.Size = UDim2.new(0, 0, 0, 2)
            Indicator.Position = UDim2.new(0, 0, 1, -2)
            Indicator.BackgroundColor3 = UIConfig.Accent
            Indicator.BorderSizePixel = 0
            Indicator.ZIndex = 2
            Indicator.Parent = SubBtn
            Indicator.BackgroundTransparency = 0

            local SubPage = Instance.new("ScrollingFrame")
            SubPage.Size = UDim2.new(1, 0, 1, 0)
            SubPage.BackgroundTransparency = 1
            SubPage.Visible = false
            SubPage.ScrollBarThickness = 5
            SubPage.ScrollBarImageColor3 = Color3.fromRGB(60, 60, 60)
            SubPage.ClipsDescendants = true
            SubPage.ZIndex = 2
            SubPage.Parent = SubPageContainer

            SubTab.SubPage = SubPage

            local LeftCol = Instance.new("Frame")
            LeftCol.Name = "LeftCol"
            LeftCol.Size = UDim2.new(0.5, -20, 1, 0)
            LeftCol.Position = UDim2.new(0, 10, 0, 0)
            LeftCol.BackgroundTransparency = 1
            LeftCol.ZIndex = 2
            LeftCol.Parent = SubPage

            local RightCol = Instance.new("Frame")
            RightCol.Name = "RightCol"
            RightCol.Size = UDim2.new(0.5, -20, 1, 0)
            RightCol.Position = UDim2.new(0.5, 10, 0, 0)
            RightCol.BackgroundTransparency = 1
            RightCol.ZIndex = 2
            RightCol.Parent = SubPage

            local LeftList = Instance.new("UIListLayout")
            LeftList.Padding = UDim.new(0, 10)
            LeftList.Parent = LeftCol

            local RightList = Instance.new("UIListLayout")
            RightList.Padding = UDim.new(0, 10)
            RightList.Parent = RightCol

            local function UpdateCanvas()
                local leftHeight = LeftList.AbsoluteContentSize.Y
                local rightHeight = RightList.AbsoluteContentSize.Y
                local maxHeight = math.max(leftHeight, rightHeight)
                SubPage.CanvasSize = UDim2.new(0, 0, 0, maxHeight)
            end

            LeftList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(UpdateCanvas)
            RightList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(UpdateCanvas)

            --Store the SubBtn reference properly
            SubTab.SubBtn = SubBtn

            table.insert(ThemeUpdateFunctions, function()
                Indicator.BackgroundColor3 = UIConfig.Accent
                SubStroke.Color = UIConfig.Outline
            end)

            SubBtn.MouseButton1Click:Connect(function()
                for _, s in pairs(Tab.SubTabs) do
                    if s.SubBtn ~= SubBtn then
                        s.SubPage.Visible = false
                        TweenObject(s.Indicator, { Size = UDim2.new(0, 0, 0, 2) }, 0.2)
                        TweenObject(s.SubBtn, { TextColor3 = UIConfig.TextDim, BackgroundColor3 = UIConfig.SecondaryColor }, 0.2)
                        TweenObject(s.SubStroke, { Color = UIConfig.Outline }, 0.2)
                    end
                end
                TweenObject(Indicator, { Size = UDim2.new(1, 0, 0, 2) }, 0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
                TweenObject(SubBtn, { BackgroundColor3 = UIConfig.SecondaryColor }, 0.2)
                TweenObject(SubStroke, { Color = UIConfig.Outline }, 0.2)
                SubPage.Visible = true

                --Auto - show all waypoints when Waypoint tab is opened
                if subName == "Waypoint" then
                    -- Trigger global update if available
                    if _G.UpdateWaypointList then _G.UpdateWaypointList() end
                end
            end)

            table.insert(Tab.SubTabs, {
                SubBtn = SubBtn,
                SubStroke = SubStroke,
                Indicator = Indicator,
                SubPage = SubPage,
                SubTab = SubTab
            })

            if #Tab.SubTabs == 1 then
                Indicator.Size = UDim2.new(1, 0, 0, 2)
                SubBtn.BackgroundColor3 = UIConfig.SecondaryColor
                SubStroke.Color = UIConfig.Outline
                SubPage.Visible = true
            end

            function SubTab:Section(title, side)
                local Section = {}
                local ParentCol = (side == "Right") and RightCol or LeftCol

                local SecFrame = Instance.new("Frame")
                SecFrame.Name = "SecFrame"
                SecFrame.Size = UDim2.new(1, 0, 0, 0)
                SecFrame.BackgroundColor3 = UIConfig.SectionColor
                SecFrame.BackgroundTransparency = 0
                SecFrame.BorderSizePixel = 0
                SecFrame.ZIndex = 2
                SecFrame.Parent = ParentCol

                local SecStroke = Instance.new("UIStroke")
                SecStroke.Color = UIConfig.Outline
                SecStroke.Parent = SecFrame

                local GoldLine = Instance.new("Frame")
                GoldLine.Name = "GoldLine"
                GoldLine.Size = UDim2.new(1, 0, 0, 1)
                GoldLine.BackgroundColor3 = UIConfig.Accent
                GoldLine.BackgroundTransparency = 0
                GoldLine.BorderSizePixel = 0
                GoldLine.ZIndex = 2
                GoldLine.Parent = SecFrame

                local Gradient = Instance.new("UIGradient")
                Gradient.Color = ColorSequence.new{
                    ColorSequenceKeypoint.new(0, UIConfig.Accent),
                    ColorSequenceKeypoint.new(1, UIConfig.SectionColor)
                }
                Gradient.Parent = GoldLine

                table.insert(ThemeUpdateFunctions, function()
                    SecFrame.BackgroundColor3 = UIConfig.SectionColor
                    SecStroke.Color = UIConfig.Outline
                    GoldLine.BackgroundColor3 = UIConfig.Accent
                    Gradient.Color = ColorSequence.new{
                        ColorSequenceKeypoint.new(0, UIConfig.Accent),
                        ColorSequenceKeypoint.new(1, UIConfig.SectionColor)
                    }
                end)

                local Title = Instance.new("TextLabel")
                Title.Name = "SectionTitle"
                Title.Text = title
                Title.Font = UIConfig.Font
                Title.TextSize = 12
                Title.TextColor3 = UIConfig.Text
                Title.TextTransparency = 0
                Title.BackgroundTransparency = 1
                Title.Size = UDim2.new(1, -20, 0, 30)
                Title.Position = UDim2.new(0, 10, 0, 5)
                Title.TextXAlignment = Enum.TextXAlignment.Left
                Title.ZIndex = 2
                Title.Parent = SecFrame

                local Container = Instance.new("Frame")
                Container.Name = "Container"
                Container.Size = UDim2.new(1, -20, 0, 0)
                Container.Position = UDim2.new(0, 10, 0, 35)
                Container.BackgroundTransparency = 1
                Container.ZIndex = 2
                Container.Parent = SecFrame

                local List = Instance.new("UIListLayout")
                List.Padding = UDim.new(0, 5)
                List.SortOrder = Enum.SortOrder.LayoutOrder
                List.Parent = Container

                List:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                    Container.Size = UDim2.new(1, -20, 0, List.AbsoluteContentSize.Y)
                    SecFrame.Size = UDim2.new(1, 0, 0, List.AbsoluteContentSize.Y + 45)
                end)

                Section.Container = Container

                function Section:Toggle(text, default, callback)
                    local toggled = default or false
                    local Frame = Instance.new("TextButton")
                    Frame.Size = UDim2.new(1, 0, 0, 25)
                    Frame.BackgroundTransparency = 1
                    Frame.Text = ""
                    Frame.ZIndex = 2
                    Frame.Parent = Container

                    local Checkbox = Instance.new("Frame")
                    Checkbox.Size = UDim2.new(0, 14, 0, 14)
                    Checkbox.Position = UDim2.new(0, 0, 0.5, -7)
                    Checkbox.BackgroundColor3 = toggled and UIConfig.Accent or Color3.fromRGB(25, 25, 25)
                    Checkbox.BorderSizePixel = 0
                    Checkbox.ZIndex = 2
                    Checkbox.Parent = Frame

                    local CheckStroke = Instance.new("UIStroke")
                    CheckStroke.Color = UIConfig.Outline
                    CheckStroke.Parent = Checkbox

                    local Label = Instance.new("TextLabel")
                    Label.Text = text
                    Label.Font = UIConfig.Font
                    Label.TextSize = 12
                    Label.TextColor3 = UIConfig.Text
                    Label.BackgroundTransparency = 1
                    Label.Position = UDim2.new(0, 24, 0, 0)
                    Label.Size = UDim2.new(1, -24, 1, 0)
                    Label.TextXAlignment = Enum.TextXAlignment.Left
                    Label.ZIndex = 2
                    Label.Parent = Frame

                    local function UpdateToggle()
                        if toggled then
                            Checkbox.BackgroundColor3 = UIConfig.Accent
                        else
                            Checkbox.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
                        end
                        CheckStroke.Color = UIConfig.Outline
                        Label.TextColor3 = UIConfig.Text
                    end
                    table.insert(ThemeUpdateFunctions, UpdateToggle)
                    
                    -- Also add to global config update functions so Load button refreshes UI
                    table.insert(_G.ConfigUpdateFunctions, function()
                         -- This is a simplified approach; normally you'd need to link this to a specific setting key
                         -- For now, we rely on the callback being idempotent or just refreshing visuals
                         UpdateToggle()
                    end)

                    Frame.MouseButton1Click:Connect(function()
                        toggled = not toggled
                        TweenObject(Checkbox, {
                            Size = UDim2.new(0, 16, 0, 16),
                            BackgroundColor3 = toggled and UIConfig.Accent or Color3.fromRGB(25, 25, 25)
                        }, 0.1, Enum.EasingStyle.Back, Enum.EasingDirection.Out):Play()
                        task.wait(0.1)
                        TweenObject(Checkbox, { Size = UDim2.new(0, 14, 0, 14) }, 0.1):Play()
                        if callback then callback(toggled) end
                    end)
                end

                function Section:Slider(text, min, max, default, callback)
                    local current = default
                    local Frame = Instance.new("Frame")
                    Frame.Size = UDim2.new(1, 0, 0, 40)
                    Frame.BackgroundTransparency = 1
                    Frame.ZIndex = 2
                    Frame.Parent = Container

                    local Label = Instance.new("TextLabel")
                    Label.Text = text
                    Label.Font = UIConfig.Font
                    Label.TextSize = 12
                    Label.TextColor3 = UIConfig.TextDim
                    Label.BackgroundTransparency = 1
                    Label.Size = UDim2.new(1, 0, 0, 20)
                    Label.TextXAlignment = Enum.TextXAlignment.Left
                    Label.ZIndex = 2
                    Label.Parent = Frame

                    local percentage = math.floor((current - min) / (max - min) * 100)

                    local Value = Instance.new("TextLabel")
                    Value.Text = tostring(percentage) .. "%"
                    Value.Font = UIConfig.Font
                    Value.TextSize = 12
                    Value.TextColor3 = UIConfig.Text
                    Value.BackgroundTransparency = 1
                    Value.Size = UDim2.new(1, 0, 0, 20)
                    Value.TextXAlignment = Enum.TextXAlignment.Right
                    Value.ZIndex = 2
                    Value.Parent = Frame

                    local Bar = Instance.new("Frame")
                    Bar.Size = UDim2.new(1, 0, 0, 6)
                    Bar.Position = UDim2.new(0, 0, 0, 25)
                    Bar.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
                    Bar.BorderSizePixel = 0
                    Bar.ZIndex = 2
                    Bar.Parent = Frame

                    local Fill = Instance.new("Frame")
                    Fill.Size = UDim2.new((current - min) / (max - min), 0, 1, 0)
                    Fill.BackgroundColor3 = UIConfig.Accent
                    Fill.BorderSizePixel = 0
                    Fill.ZIndex = 2
                    Fill.Parent = Bar

                    table.insert(ThemeUpdateFunctions, function()
                        Fill.BackgroundColor3 = UIConfig.Accent
                        Label.TextColor3 = UIConfig.TextDim
                        Value.TextColor3 = UIConfig.Text
                    end)

                    local Button = Instance.new("TextButton")
                    Button.Size = UDim2.new(1, 0, 1, 0)
                    Button.BackgroundTransparency = 1
                    Button.Text = ""
                    Button.ZIndex = 3
                    Button.Parent = Bar

                    local dragging = false
                    Button.MouseButton1Down:Connect(function() dragging = true end)
                    UserInputService.InputEnded:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
                    end)

                    RunService.RenderStepped:Connect(function()
                        if dragging then
                            local mPos = UserInputService:GetMouseLocation().X
                            local rel = mPos - Bar.AbsolutePosition.X
                            local pct = math.clamp(rel / Bar.AbsoluteSize.X, 0, 1)
                            current = min + (max - min) * pct
                            percentage = math.floor(pct * 100)
                            AnimateSliderFill(Fill, UDim2.new(pct, 0, 1, 0))
                            Value.Text = tostring(percentage) .. "%"
                            if callback then callback(current) end
                        end
                    end)
                end

                function Section:Button(text, callback)
                    local Frame = Instance.new("TextButton")
                    Frame.Size = UDim2.new(1, 0, 0, 25)
                    Frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
                    Frame.Text = text
                    Frame.TextColor3 = UIConfig.Text
                    Frame.Font = Enum.Font.Gotham
                    Frame.TextSize = 12
                    Frame.BorderSizePixel = 0
                    Frame.ZIndex = 2
                    Frame.Parent = Container

                    local Stroke = Instance.new("UIStroke")
                    Stroke.Color = UIConfig.Outline
                    Stroke.Parent = Frame

                    table.insert(ThemeUpdateFunctions, function()
                        Frame.TextColor3 = UIConfig.Text
                        Stroke.Color = UIConfig.Outline
                    end)

                    Frame.MouseButton1Down:Connect(function()
                        TweenObject(Frame, { BackgroundColor3 = UIConfig.Accent }, 0.1)
                    end)

                    Frame.MouseButton1Up:Connect(function()
                        TweenObject(Frame, { BackgroundColor3 = Color3.fromRGB(25, 25, 25) }, 0.2)
                    end)

                    Frame.MouseButton1Click:Connect(callback)
                end

                function Section:Dropdown(text, options, default, callback)
                    local Frame = Instance.new("Frame")
                    Frame.Size = UDim2.new(1, 0, 0, 45)
                    Frame.BackgroundTransparency = 1
                    Frame.ZIndex = 2
                    Frame.Parent = Container

                    local Label = Instance.new("TextLabel")
                    Label.Text = text
                    Label.Font = UIConfig.Font
                    Label.TextSize = 12
                    Label.TextColor3 = UIConfig.TextDim
                    Label.BackgroundTransparency = 1
                    Label.Size = UDim2.new(1, 0, 0, 20)
                    Label.TextXAlignment = Enum.TextXAlignment.Left
                    Label.ZIndex = 2
                    Label.Parent = Frame

                    local Drop = Instance.new("TextButton")
                    Drop.Size = UDim2.new(1, 0, 0, 25)
                    Drop.Position = UDim2.new(0, 0, 0, 20)
                    Drop.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
                    Drop.Text = " " .. (default or "None")
                    Drop.TextColor3 = UIConfig.Text
                    Drop.Font = UIConfig.Font
                    Drop.TextSize = 12
                    Drop.TextXAlignment = Enum.TextXAlignment.Left
                    Drop.BorderSizePixel = 0
                    Drop.ZIndex = 2
                    Drop.Parent = Frame

                    local Stroke = Instance.new("UIStroke")
                    Stroke.Color = UIConfig.Outline
                    Stroke.Parent = Drop

                    table.insert(ThemeUpdateFunctions, function()
                        Label.TextColor3 = UIConfig.TextDim
                        Drop.TextColor3 = UIConfig.Text
                        Stroke.Color = UIConfig.Outline
                    end)

                    local currentIndex = table.find(options, default) or 1

                    local function updateDropdown()
                        local selected = options[currentIndex]
                        Drop.Text = " " ..selected
                        if callback then callback(selected) end
                    end

                    Drop.MouseButton1Click:Connect(function()
                        currentIndex = currentIndex + 1
                        if currentIndex > #options then currentIndex = 1 end
                        updateDropdown()
                    end)

                    updateDropdown()
                end

                return Section
            end

            return SubTab
        end

        return Tab
    end

    return Window
end

local Window = Library:Window()

-- == = FIXED AVATAR PREVIEW FUNCTION == =
local function createRotatingAvatarPreview(parentContainer)
    if not parentContainer or not parentContainer:IsA("Instance") then
        warn("Invalid parent container")
        return nil
    end

    local VIEWPORT_HEIGHT = 250
    local VIEWPORT_ZOOM = 6
    local PreviewContainer = Instance.new("Frame")
    PreviewContainer.Name = "AvatarPreview"
    PreviewContainer.Size = UDim2.new(1, 0, 0, VIEWPORT_HEIGHT)
    PreviewContainer.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    PreviewContainer.BorderSizePixel = 0
    PreviewContainer.ZIndex = 2
    PreviewContainer.Parent = parentContainer

    local PreviewStroke = Instance.new("UIStroke")
    PreviewStroke.Color = UIConfig.Outline
    PreviewStroke.Parent = PreviewContainer

    local ViewportFrame = Instance.new("ViewportFrame")
    ViewportFrame.Size = UDim2.new(1, -10, 1, -10)
    ViewportFrame.Position = UDim2.new(0, 5, 0, 5)
    ViewportFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    ViewportFrame.BorderSizePixel = 0
    ViewportFrame.ZIndex = 3
    ViewportFrame.Parent = PreviewContainer

    local cam = Instance.new("Camera")
    cam.Parent = ViewportFrame
    ViewportFrame.CurrentCamera = cam

    local character
    if LocalPlayer.Character then
        LocalPlayer.Character.Archivable = true
        character = LocalPlayer.Character:Clone()
    else
        character = Players:CreateHumanoidModelFromUserId(LocalPlayer.UserId)
    end

    if not character then
        character = Players:CreateHumanoidModelFromUserId(LocalPlayer.UserId)
    end

    character.Name = "PreviewChar"
    character.Parent = ViewportFrame

    -- Remove scripts to prevent glitching
    for _, script in ipairs(character:GetDescendants()) do
        if script:IsA("Script") or script:IsA("LocalScript") then
            script:Destroy()
        end
    end

    -- Ensure we have a PrimaryPart to move the model
    local rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChildWhichIsA("BasePart")
    if not rootPart then
        warn("Could not find a root part for the preview model.")
        return
    end
    character.PrimaryPart = rootPart

    -- Get the geometric center of the model's bounding box
    local modelCFrame = character:GetModelCFrame()

    --Move the model so its geometric center is at the world origin(0, 0, 0)
    character:TranslateBy(-modelCFrame.Position)

    --Set the camera to look at the now - centered model
    cam.CFrame = CFrame.new(Vector3.new(0, 0, VIEWPORT_ZOOM), Vector3.new(0, 0, 0))
    local rotation = 0
    RunService.RenderStepped:Connect(function()
        if character and character.PrimaryPart then
            rotation = rotation + 0.5
            --Rotate the model in place at its new center(0, 0, 0)
            character:SetPrimaryPartCFrame(CFrame.Angles(0, math.rad(rotation), 0))
        end
    end)
end

-- Create tabs and sections
local MainTab = Window:Tab("Main")
local AimPage = MainTab:SubTab("Aimlock")
local TargetSec = AimPage:Section("Target Aim", "Left")
TargetSec:Toggle("Enabled", false, function(v) _G.Settings.Aimbot.Enabled = v end)
TargetSec:Dropdown("Method", { "CamLock", "MouseLock" }, "CamLock", function(v) _G.Settings.Aimbot.Method = v end)
TargetSec:Dropdown("Select Target", { "Closest", "Mouse", "Health" }, "Closest", function(v) _G.Settings.Aimbot.Target = v end)
TargetSec:Dropdown("Selected Part", { "Head", "Torso", "HumanoidRootPart" }, "Head", function(v) _G.Settings.Aimbot.AimPart = v end)

local PredictionSec = AimPage:Section("Prediction & smoothness", "Left")
PredictionSec:Toggle("Enabled Prediction", false, function(v) _G.Settings.Prediction.Enabled = v end)
PredictionSec:Toggle("Enabled Smoothness", true, function(v) _G.Settings.Smoothness.Enabled = v end) 
PredictionSec:Slider("Prediction Value", 0, 10, 1, function(v) _G.Settings.Prediction.Value = v / 10 end)
PredictionSec:Slider("Smoothness Value", 0, 10, 5, function(v)
    _G.Settings.Smoothness.Value = v / 10
    _G.Settings.Aimbot.Smoothness = v / 10
end)

local ChecksSec = AimPage:Section("Checks", "Right")
ChecksSec:Toggle("Team Check", false, function(v) _G.Settings.TeamCheck.Enabled = v end)
ChecksSec:Toggle("Wall Check", false, function(v) _G.Settings.WallCheck.Enabled = v end)
ChecksSec:Toggle("Knocked Check", false, function(v) _G.Settings.KnockedCheck.Enabled = v end)

local FovSec = AimPage:Section("Field Of View", "Right")
FovSec:Toggle("Enabled Fov", false, function(v) _G.Settings.Fov.Enabled = v end)
FovSec:Slider("Fov Value", 0, 10, 1, function(v) _G.Settings.Fov.Value = v / 10 end)

local ExtraSec = AimPage:Section("Extra Stuff", "Right")
ExtraSec:Toggle("Sticky", false, function(v) _G.Settings.Sticky.Enabled = v end)
ExtraSec:Toggle("HoverUI", false, function(v) _G.Settings.TriggerBot.Enabled = v end)
ExtraSec:Toggle("ResolverCam", false, function(v) _G.Settings.ResolverCam.Enabled = v end)
ExtraSec:Toggle("Highlights", false, function(v) _G.Settings.Highlights.Enabled = v end)

local RagePage = MainTab:SubTab("Ragebot")
local ExploitSec = RagePage:Section("Hitbox", "Left")
ExploitSec:Toggle("Hitbox Expander", false, function(v) _G.Settings.HitboxExpander.Enabled = v end)
ExploitSec:Toggle("Hitbox Trasnparency", false, function(v) _G.Settings.HitboxTrasnparency.Enabled = v end)
ExploitSec:Slider("Hitbox Size", 0, 10, 1, function(v) _G.Settings.HitboxSize.Value = v / 10 end)
ExploitSec:Slider("Trasnparency Value", 0, 10, 1, function(v) _G.Settings.Trasnparency.Value = v / 10 end)

local TriggerbotSec = RagePage:Section("Triggerbot", "Right")
TriggerbotSec:Toggle("Enabled", false, function(v) _G.Settings.TriggerBot.Enabled = v end)
TriggerbotSec:Toggle("Tool Only", false, function(v) _G.Settings.TriggerBot.ToolOnly = v end)
TriggerbotSec:Slider("Delay", 0, 10, 1, function(v) _G.Settings.TriggerBot.Delay = v / 10 end)

local ClientTab = Window:Tab("Client")
local GamePage = ClientTab:SubTab("Visuals")
local VisSec = GamePage:Section("Esp", "Left")
VisSec:Toggle("Enable", false, function(v) _G.Settings.Visuals.Enable = v end)
VisSec:Toggle("Box ESP", false, function(v) _G.Settings.Visuals.Box = v end)
VisSec:Dropdown("Box Type", { "3D", "2D", "Corner" }, "3D", function(v) _G.Settings.Visuals.BoxType = v end)
VisSec:Toggle("Name ESP", false, function(v) _G.Settings.Visuals.Name = v end)
VisSec:Dropdown("Name Display", { "Username", "Nickname", "Both" }, "Nickname", function(v) _G.Settings.Visuals.NameDisplay = v end)
VisSec:Toggle("Distance ESP", false, function(v) _G.Settings.Visuals.Distance = v end)
VisSec:Toggle("Health ESP", false, function(v) _G.Settings.Visuals.Health = v end)
VisSec:Toggle("Tracers", false, function(v) _G.Settings.Visuals.Tracers = v end)
VisSec:Dropdown("Tracer Position", { "Middle", "Top", "Bottom", "Follow Mouse" }, "Middle", function(v) _G.Settings.Visuals.TracerPosition = v end)
VisSec:Toggle("Weapon ESP", false, function(v) _G.Settings.Visuals.Tracer = v end)

local Checks2Sec = GamePage:Section("Checks", "Right")
Checks2Sec:Toggle("Team Check", false, function(v) _G.Settings.TeamCheck.Enabled = v end)
Checks2Sec:Toggle("Wall Check", false, function(v) _G.Settings.WallCheck.Enabled = v end)
Checks2Sec:Toggle("Knocked Check", false, function(v) _G.Settings.KnockedCheck.Enabled = v end)

local PreviewSec = GamePage:Section("Preview", "Right")
task.spawn(function()
    if PreviewSec and PreviewSec.Container then
        createRotatingAvatarPreview(PreviewSec.Container)
    end
end)

local UIPage = ClientTab:SubTab("UI")
local ThemeSec = UIPage:Section("Theme", "Left")
ThemeSec:Toggle("Exposure", false, function(v) _G.Settings.Exposure.Enabled = v end)
ThemeSec:Slider("Exposure Value", 0, 10, 1, function(v) _G.Settings.ExposureValue.Value = v / 10 end)
ThemeSec:Toggle("Ambient", false, function(v) _G.Settings.Ambient.Enabled = v end)
ThemeSec:Toggle("Fog", false, function(v) _G.Settings.Fog.Enabled = v end)
ThemeSec:Toggle("Clock Time", false, function(v) _G.Settings.ClockTime.Enabled = v end)
ThemeSec:Slider("Clock Time Value", 0, 10, 1, function(v) _G.Settings.ClockTime.Value = v / 10 end)

local BrightnessSec = UIPage:Section("Brightness", "Right")
BrightnessSec:Toggle("Full Brightness", false, function(v) _G.Settings.Brightness.Enable = v end)

local PlayersTab = Window:Tab("Players")
local PlrMain = PlayersTab:SubTab("Main")

--Players system variables
local selectedPlayer = nil
local lockedTarget = nil
local activeAction = nil
local activeLoop = nil
local playerStatuses = {}

--Players UI
local CustomContainer = Instance.new("Frame")
CustomContainer.Name = "CustomPlayerAdmin"
CustomContainer.Size = UDim2.new(1, -20, 1, -10)
CustomContainer.Position = UDim2.new(0, 10, 0, 5)
CustomContainer.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
CustomContainer.BackgroundTransparency = 0
CustomContainer.BorderSizePixel = 0
CustomContainer.ZIndex = 5
CustomContainer.Parent = PlrMain.SubPage

-- FIX: Disable scrolling in Player tab
PlrMain.SubPage.ScrollingEnabled = false

local SearchBar = Instance.new("TextBox")
SearchBar.Size = UDim2.new(1, -20, 0, 35)
SearchBar.Position = UDim2.new(0, 10, 0, 10)
SearchBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
SearchBar.BorderSizePixel = 1
SearchBar.BorderColor3 = Color3.fromRGB(40, 40, 40)
SearchBar.Text = ""
SearchBar.PlaceholderText = "Search players..."
SearchBar.TextColor3 = Color3.fromRGB(255, 255, 255)
SearchBar.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
SearchBar.Font = Enum.Font.Gotham
SearchBar.TextSize = 14
SearchBar.TextXAlignment = Enum.TextXAlignment.Left
SearchBar.ZIndex = 6
SearchBar.Parent = CustomContainer

local SPad = Instance.new("UIPadding")
SPad.PaddingLeft = UDim.new(0, 10)
SPad.Parent = SearchBar

local ListFrame = Instance.new("ScrollingFrame")
ListFrame.Size = UDim2.new(1, -20, 0, 180)
ListFrame.Position = UDim2.new(0, 10, 0, 55)
ListFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
ListFrame.BorderSizePixel = 1
ListFrame.BorderColor3 = Color3.fromRGB(40, 40, 40)
ListFrame.ScrollBarThickness = 4
ListFrame.ScrollBarImageColor3 = Color3.fromRGB(60, 60, 60)
ListFrame.ZIndex = 6
ListFrame.Parent = CustomContainer

local ListLayout = Instance.new("UIListLayout")
ListLayout.SortOrder = Enum.SortOrder.Name
ListLayout.Parent = ListFrame

local InfoArea = Instance.new("Frame")
InfoArea.Size = UDim2.new(1, -20, 0, 90)
InfoArea.Position = UDim2.new(0, 10, 0, 245)
InfoArea.BackgroundTransparency = 1
InfoArea.ZIndex = 6
InfoArea.Parent = CustomContainer

local AvatarImg = Instance.new("ImageLabel")
AvatarImg.Size = UDim2.new(0, 70, 0, 70)
AvatarImg.Position = UDim2.new(0, 0, 0, 10)
AvatarImg.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
AvatarImg.BackgroundTransparency = 0.5
AvatarImg.BorderSizePixel = 0
AvatarImg.ZIndex = 7
AvatarImg.Parent = InfoArea

local NameLbl = Instance.new("TextLabel")
NameLbl.Size = UDim2.new(1, -200, 0, 20)
NameLbl.Position = UDim2.new(0, 80, 0, 10)
NameLbl.BackgroundTransparency = 1
NameLbl.Text = "Select a player"
NameLbl.TextColor3 = Color3.fromRGB(255, 255, 255)
NameLbl.Font = Enum.Font.Gotham
NameLbl.TextSize = 14
NameLbl.TextXAlignment = Enum.TextXAlignment.Left
NameLbl.ZIndex = 7
NameLbl.Parent = InfoArea

local AgeLbl = Instance.new("TextLabel")
AgeLbl.Size = UDim2.new(1, -200, 0, 20)
AgeLbl.Position = UDim2.new(0, 80, 0, 30)
AgeLbl.BackgroundTransparency = 1
AgeLbl.Text = ""
AgeLbl.TextColor3 = Color3.fromRGB(200, 200, 200)
AgeLbl.Font = Enum.Font.Gotham
AgeLbl.TextSize = 12
AgeLbl.TextXAlignment = Enum.TextXAlignment.Left
AgeLbl.ZIndex = 7
AgeLbl.Parent = InfoArea

local StatusTitle = Instance.new("TextLabel")
StatusTitle.Text = "Status"
StatusTitle.Size = UDim2.new(0, 100, 0, 20)
StatusTitle.Position = UDim2.new(1, -160, 0, 10)
StatusTitle.BackgroundTransparency = 1
StatusTitle.TextColor3 = Color3.fromRGB(200, 200, 200)
StatusTitle.Font = Enum.Font.Gotham
StatusTitle.TextSize = 12
StatusTitle.TextXAlignment = Enum.TextXAlignment.Left
StatusTitle.ZIndex = 7
StatusTitle.Parent = InfoArea

local StatusBtn = Instance.new("TextButton")
StatusBtn.Size = UDim2.new(0, 160, 0, 30)
StatusBtn.Position = UDim2.new(1, -160, 0, 30)
StatusBtn.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
StatusBtn.BorderSizePixel = 0
StatusBtn.Text = " Neutral"
StatusBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
StatusBtn.Font = Enum.Font.Gotham
StatusBtn.TextSize = 12
StatusBtn.TextXAlignment = Enum.TextXAlignment.Left
StatusBtn.ZIndex = 7
StatusBtn.Parent = InfoArea

local StatusArrow = Instance.new("TextLabel")
StatusArrow.Text = "v"
StatusArrow.Size = UDim2.new(0, 20, 1, 0)
StatusArrow.Position = UDim2.new(1, -20, 0, 0)
StatusArrow.BackgroundTransparency = 1
StatusArrow.TextColor3 = Color3.fromRGB(255, 215, 0)
StatusArrow.Font = Enum.Font.GothamBold
StatusArrow.TextSize = 10
StatusArrow.ZIndex = 8
StatusArrow.Parent = StatusBtn

local statusOpts = { "Neutral", "Friend", "Enemy" }
StatusBtn.MouseButton1Click:Connect(function()
    if not selectedPlayer then return end
    local current = StatusBtn.Text:gsub(" ", "")
    local idx = table.find(statusOpts, current) or 1
    idx = idx + 1
    if idx > #statusOpts then idx = 1 end
    local newS = statusOpts[idx]
    StatusBtn.Text = " " ..newS
    playerStatuses[selectedPlayer.UserId] = newS
    if newS == "Friend" then
        StatusBtn.TextColor3 = Color3.fromRGB(100, 255, 100)
    elseif newS == "Enemy" then
        StatusBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
    else
        StatusBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    end
    Refresh()
end)

local ButtonsArea = Instance.new("Frame")
ButtonsArea.Name = "ButtonsArea"
ButtonsArea.Size = UDim2.new(1, -20, 0, 70)
ButtonsArea.Position = UDim2.new(0, 10, 0, 345)
ButtonsArea.BackgroundTransparency = 1
ButtonsArea.ZIndex = 6
ButtonsArea.Parent = CustomContainer

local buttonWidth = 110
local buttonHeight = 30
local spacing = 10

local TeleportBtn = Instance.new("TextButton")
TeleportBtn.Size = UDim2.new(0, buttonWidth, 0, buttonHeight)
TeleportBtn.Position = UDim2.new(0, 0, 0, 0)
TeleportBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
TeleportBtn.BorderColor3 = Color3.fromRGB(40, 40, 40)
TeleportBtn.BorderSizePixel = 1
TeleportBtn.Text = "Teleport"
TeleportBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
TeleportBtn.Font = Enum.Font.Gotham
TeleportBtn.TextSize = 12
TeleportBtn.ZIndex = 7
TeleportBtn.Parent = ButtonsArea

local SpectateBtn = Instance.new("TextButton")
SpectateBtn.Size = UDim2.new(0, buttonWidth, 0, buttonHeight)
SpectateBtn.Position = UDim2.new(0, buttonWidth + spacing, 0, 0)
SpectateBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
SpectateBtn.BorderColor3 = Color3.fromRGB(40, 40, 40)
SpectateBtn.BorderSizePixel = 1
SpectateBtn.Text = "Spectate"
SpectateBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
SpectateBtn.Font = Enum.Font.Gotham
SpectateBtn.TextSize = 12
SpectateBtn.ZIndex = 7
SpectateBtn.Parent = ButtonsArea

local FlingBtn = Instance.new("TextButton")
FlingBtn.Size = UDim2.new(0, buttonWidth, 0, buttonHeight)
FlingBtn.Position = UDim2.new(0, (buttonWidth + spacing) * 2, 0, 0)
FlingBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
FlingBtn.BorderColor3 = Color3.fromRGB(40, 40, 40)
FlingBtn.BorderSizePixel = 1
FlingBtn.Text = "Fling"
FlingBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
FlingBtn.Font = Enum.Font.Gotham
FlingBtn.TextSize = 12
FlingBtn.ZIndex = 7
FlingBtn.Parent = ButtonsArea

local LoopTPBtn = Instance.new("TextButton")
LoopTPBtn.Size = UDim2.new(0, buttonWidth, 0, buttonHeight)
LoopTPBtn.Position = UDim2.new(0, 0, 0, buttonHeight + spacing)
LoopTPBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
LoopTPBtn.BorderColor3 = Color3.fromRGB(40, 40, 40)
LoopTPBtn.BorderSizePixel = 1
LoopTPBtn.Text = "Loop TP"
LoopTPBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
LoopTPBtn.Font = Enum.Font.Gotham
LoopTPBtn.TextSize = 12
LoopTPBtn.ZIndex = 7
LoopTPBtn.Parent = ButtonsArea

local TargetStrafeBtn = Instance.new("TextButton")
TargetStrafeBtn.Size = UDim2.new(0, buttonWidth, 0, buttonHeight)
TargetStrafeBtn.Position = UDim2.new(0, buttonWidth + spacing, 0, buttonHeight + spacing)
TargetStrafeBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
TargetStrafeBtn.BorderColor3 = Color3.fromRGB(40, 40, 40)
TargetStrafeBtn.BorderSizePixel = 1
TargetStrafeBtn.Text = "Target Strafe"
TargetStrafeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
TargetStrafeBtn.Font = Enum.Font.Gotham
TargetStrafeBtn.TextSize = 12
TargetStrafeBtn.ZIndex = 7
TargetStrafeBtn.Parent = ButtonsArea

local function UpdateInfo()
    if selectedPlayer then
        NameLbl.Text = selectedPlayer.DisplayName .. " - " ..selectedPlayer.UserId
        AgeLbl.Text = "Account Age: " ..selectedPlayer.AccountAge .. " days"
        pcall(function()
            AvatarImg.Image = "rbxthumb://type=AvatarHeadShot&id=" ..selectedPlayer.UserId .. "&w=150&h=150"
        end)
        local s = playerStatuses[selectedPlayer.UserId] or "Neutral"
        StatusBtn.Text = " " ..s
        if s == "Friend" then
            StatusBtn.TextColor3 = Color3.fromRGB(100, 255, 100)
        elseif s == "Enemy" then
            StatusBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
        else
            StatusBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        end
    else
        NameLbl.Text = "Select a player"
        AgeLbl.Text = ""
        AvatarImg.Image = ""
        StatusBtn.Text = " Neutral"
        StatusBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    end
end

local function RestoreCollision()
    if LocalPlayer.Character then
        for _, part in ipairs(LocalPlayer.Character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = true
                part.Massless = false
            end
        end
    end
end

local function StopActive()
    if activeLoop then
        activeLoop:Disconnect()
        activeLoop = nil
    end
    if activeAction == "Spectate" then
        Camera.CameraSubject = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid")
    end
    if activeAction == "Loop TP" and lockedTarget and lockedTarget.Character then
        local tRoot = lockedTarget.Character:FindFirstChild("HumanoidRootPart")
        if tRoot then
            tRoot.Anchored = false
        end
    end
    RestoreCollision()
    if activeAction then
        if activeAction == "Spectate" then
            SpectateBtn.Text = "Spectate"
            TweenObject(SpectateBtn, { BackgroundColor3 = Color3.fromRGB(20, 20, 20) }, 0.2)
        elseif activeAction == "Fling" then
            FlingBtn.Text = "Fling"
            TweenObject(FlingBtn, { BackgroundColor3 = Color3.fromRGB(20, 20, 20) }, 0.2)
        elseif activeAction == "Loop TP" then
            LoopTPBtn.Text = "Loop TP"
            TweenObject(LoopTPBtn, { BackgroundColor3 = Color3.fromRGB(20, 20, 20) }, 0.2)
        elseif activeAction == "Strafe" then
            TargetStrafeBtn.Text = "Target Strafe"
            TweenObject(TargetStrafeBtn, { BackgroundColor3 = Color3.fromRGB(20, 20, 20) }, 0.2)
        end
    end
    activeAction = nil
    lockedTarget = nil
end

TeleportBtn.MouseButton1Click:Connect(function()
    if not selectedPlayer or not selectedPlayer.Character then return end
    local targetRoot = selectedPlayer.Character:FindFirstChild("HumanoidRootPart")
    local targetHead = selectedPlayer.Character:FindFirstChild("Head")
    local myRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if targetHead and myRoot then
        myRoot.CFrame = targetHead.CFrame * CFrame.new(0, 3, 0)
    elseif targetRoot and myRoot then
        myRoot.CFrame = targetRoot.CFrame * CFrame.new(0, 5, 0)
    end
end)

SpectateBtn.MouseButton1Click:Connect(function()
    if activeAction == "Spectate" then
        StopActive()
    else
        StopActive()
        if not selectedPlayer or not selectedPlayer.Character then return end
        lockedTarget = selectedPlayer
        activeAction = "Spectate"
        SpectateBtn.Text = "Unspectate"
        TweenObject(SpectateBtn, { BackgroundColor3 = UIConfig.Accent }, 0.2)
        Camera.CameraSubject = lockedTarget.Character:FindFirstChild("Humanoid")
        activeLoop = lockedTarget.AncestryChanged:Connect(function()
            if not lockedTarget:IsDescendantOf(game) then
                StopActive()
            end
        end)
    end
end)

FlingBtn.MouseButton1Click:Connect(function()
    if activeAction == "Fling" then
        StopActive()
    else
        StopActive()
        if not selectedPlayer then return end
        lockedTarget = selectedPlayer
        activeAction = "Fling"
        FlingBtn.Text = "Stop Fling"
        TweenObject(FlingBtn, { BackgroundColor3 = UIConfig.Accent }, 0.2)
        local flingPower = 10000
        local rot = 0
        activeLoop = RunService.Heartbeat:Connect(function()
            if not lockedTarget or not lockedTarget.Character or not LocalPlayer.Character then return end
            local tRoot = lockedTarget.Character:FindFirstChild("HumanoidRootPart")
            local myRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if tRoot and myRoot then
                rot = rot + 100
                myRoot.CFrame = tRoot.CFrame * CFrame.Angles(0, math.rad(rot), 0)
                myRoot.Velocity = Vector3.new(0, flingPower, 0)
            end
        end)
    end
end)

LoopTPBtn.MouseButton1Click:Connect(function()
    if activeAction == "Loop TP" then
        StopActive()
    else
        StopActive()
        if not selectedPlayer then return end
        lockedTarget = selectedPlayer
        activeAction = "Loop TP"
        LoopTPBtn.Text = "Stop Loop"
        TweenObject(LoopTPBtn, { BackgroundColor3 = UIConfig.Accent }, 0.2)
        local myParts = {}
        local function CacheParts()
            if LocalPlayer.Character then
                myParts = {}
                for _, v in ipairs(LocalPlayer.Character:GetDescendants()) do
                    if v:IsA("BasePart") then
                        table.insert(myParts, v)
                    end
                end
            end
        end
        CacheParts()
        LocalPlayer.CharacterAdded:Connect(function()
            if activeAction == "Loop TP" then
                task.wait(0.5)
                CacheParts()
            end
        end)
        activeLoop = RunService.Stepped:Connect(function()
            if not lockedTarget or not lockedTarget.Character or not LocalPlayer.Character then return end
            local tRoot = lockedTarget.Character:FindFirstChild("HumanoidRootPart")
            local myRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if tRoot and myRoot then
                myRoot.CFrame = tRoot.CFrame
                myRoot.Velocity = Vector3.zero
                myRoot.AssemblyLinearVelocity = Vector3.zero
                myRoot.AssemblyAngularVelocity = Vector3.zero
                if tRoot then
                    tRoot.Anchored = true
                end
            end
            for _, part in ipairs(myParts) do
                if part and part:IsA("BasePart") then
                    part.CanCollide = false
                    part.Massless = true
                end
            end
        end)
    end
end)

TargetStrafeBtn.MouseButton1Click:Connect(function()
    if activeAction == "Strafe" then
        StopActive()
    else
        StopActive()
        if not selectedPlayer then return end
        lockedTarget = selectedPlayer
        activeAction = "Strafe"
        TargetStrafeBtn.Text = "Stop Orbit"
        TweenObject(TargetStrafeBtn, { BackgroundColor3 = UIConfig.Accent }, 0.2)
        local hAngle, vAngle = 0, 0
        activeLoop = RunService.Heartbeat:Connect(function(dt)
            if not lockedTarget or not lockedTarget.Character or not LocalPlayer.Character then return end
            local tRoot = lockedTarget.Character:FindFirstChild("HumanoidRootPart")
            local myRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if tRoot and myRoot then
                hAngle = hAngle + dt * 15
                vAngle = vAngle + dt * 4
                local radius = 10
                local offset = Vector3.new(
                    math.cos(hAngle) * math.cos(vAngle) * radius,
                    math.sin(vAngle) * radius,
                    math.sin(hAngle) * math.cos(vAngle) * radius
                )
                local targetCFrame = CFrame.lookAt(tRoot.Position + offset, tRoot.Position)
                local rollCFrame = CFrame.Angles(0, 0, os.clock() * 8)
                myRoot.CFrame = targetCFrame * rollCFrame
            end
        end)
    end
end)

function Refresh()
    for _, v in pairs(ListFrame:GetChildren()) do if v:IsA("Frame") then v:Destroy() end end
    local filter = SearchBar.Text:lower()
    for _, p in pairs(Players:GetPlayers()) do
        if filter == "" or p.Name:lower():find(filter) or p.DisplayName:lower():find(filter) then
            local Row = Instance.new("Frame")
            Row.Size = UDim2.new(1, 0, 0, 25)
            Row.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
            Row.BorderSizePixel = 0
            Row.ZIndex = 7
            Row.Parent = ListFrame

            local Btn = Instance.new("TextButton")
            Btn.Size = UDim2.new(1, 0, 1, 0)
            Btn.BackgroundTransparency = 1
            Btn.Text = ""
            Btn.ZIndex = 8
            Btn.Parent = Row

            local statusColor = Color3.fromRGB(200, 200, 200)
            local status = playerStatuses[p.UserId] or "Neutral"
            if p == LocalPlayer then
                statusColor = Color3.fromRGB(255, 215, 0)
                status = "LocalPlayer"
            elseif status == "Friend" then
                statusColor = Color3.fromRGB(100, 255, 100)
            elseif status == "Enemy" then
                statusColor = Color3.fromRGB(255, 100, 100)
            end

            local NameT = Instance.new("TextLabel")
            NameT.Text = p.Name .. " - (@" ..p.DisplayName .. ")"
            NameT.Size = UDim2.new(0.5, 0, 1, 0)
            NameT.Position = UDim2.new(0, 5, 0, 0)
            NameT.BackgroundTransparency = 1
            NameT.TextColor3 = statusColor
            if p == selectedPlayer then
                NameT.TextColor3 = Color3.fromRGB(255, 255, 100)
            end
            NameT.TextXAlignment = Enum.TextXAlignment.Left
            NameT.Font = Enum.Font.Gotham
            NameT.TextSize = 12
            NameT.ZIndex = 8
            NameT.Parent = Row

            local TeamT = Instance.new("TextLabel")
            TeamT.Text = "None"
            TeamT.Size = UDim2.new(0.2, 0, 1, 0)
            TeamT.Position = UDim2.new(0.5, 0, 0, 0)
            TeamT.BackgroundTransparency = 1
            TeamT.TextColor3 = Color3.fromRGB(200, 200, 200)
            TeamT.Font = Enum.Font.Gotham
            TeamT.TextSize = 12
            TeamT.ZIndex = 8
            TeamT.Parent = Row

            local StatT = Instance.new("TextLabel")
            StatT.Text = status
            StatT.Size = UDim2.new(0.2, 0, 1, 0)
            StatT.Position = UDim2.new(0.8, 0, 0, 0)
            StatT.BackgroundTransparency = 1
            StatT.TextColor3 = statusColor
            StatT.Font = Enum.Font.Gotham
            StatT.TextSize = 12
            StatT.ZIndex = 8
            StatT.Parent = Row

            Btn.MouseButton1Click:Connect(function()
                selectedPlayer = p
                UpdateInfo()
                Refresh()
            end)
        end
    end
    ListFrame.CanvasSize = UDim2.new(0, 0, 0, ListLayout.AbsoluteContentSize.Y)
end

SearchBar:GetPropertyChangedSignal("Text"):Connect(Refresh)
Players.PlayerAdded:Connect(Refresh)
Players.PlayerRemoving:Connect(Refresh)
Refresh()

local MiscTab = Window:Tab("Misc")
local MiscMain = MiscTab:SubTab("Main")
local LocalSec = MiscMain:Section("Movement", "Left")
LocalSec:Toggle("Player Speed", false, function(v) _G.Settings.Speed.Enable = v end)
LocalSec:Toggle("Player Jump", false, function(v) _G.Settings.Jump.Enable = v end)
LocalSec:Toggle("Player Fly", false, function(v) _G.Settings.Fly.Enable = v end)
LocalSec:Toggle("No-Clip", false, function(v) _G.Settings.Fly.Enable = v end)

local LocalSec = MiscMain:Section("Movement Value", "Right")
LocalSec:Slider("Speed Value", 0, 100, 16, function(v) _G.Settings.Player.WalkSpeed = v end)
LocalSec:Slider("Jump Value", 0, 100, 50, function(v) _G.Settings.Player.JumpPower = v end)
LocalSec:Slider("Fly Value", 0, 100, 20, function(v) _G.Settings.Player.FlySpeed = v end)

local LocalSec = MiscMain:Section("Player", "Left")
LocalSec:Toggle("Infinite Zoom", false, function(v) _G.Settings.InfiniteZoom.Enable = v end)
LocalSec:Toggle("Chat Spy", false, function(v) _G.Settings.ChatSpy.Enable = v end)
LocalSec:Toggle("Disable Chairs", false, function(v) _G.Settings.DisableChairs.Enable = v end)
LocalSec:Toggle("Anti-Fling", false, function(v) _G.Settings.AntiFling.Enable = v end)

local LocalSec = MiscMain:Section("Damage Number", "Left")
LocalSec:Toggle("Damage Number", false, function(v) _G.Settings.DamageNumber.Enable = v end)

local LocalSec = MiscMain:Section("Damage Number", "Right")
LocalSec:Toggle("Hit Sound", false, function(v) _G.Settings.HitSound.Enable = v end)
LocalSec:Dropdown("Hit Sound", { "3D", "2D", "Corner" }, "2D", function(v) _G.Settings.HitSound.Type = v end)

local AvSec = MiscMain:Section("Avatar Changer", "Right")
AvSec:Button("Apply Avatar", function() end)
AvSec:Button("Reset Avatar", function() end)

--FIXED WAYPOINTS SYSTEM WITH SIMPLE SATELLITE VIEW
local WaypointsPage = MiscTab:SubTab("Waypoint")

--Waypoints system variables
local Waypoints = {}
local SelectedWaypoint = nil
local IsViewing = false
local ViewConnections = {}
local IsTeleporting = false
local ViewButton = nil
local SatelliteHUD = nil

local WaypointFilePath = "NerdWare_Waypoints_" ..game.PlaceId .. ".json"

--FIX: Disable scrolling in Waypoint tab
WaypointsPage.SubPage.ScrollingEnabled = false

-- == VISUAL EFFECTS ==
local function CreateEffect(name, className)
    local existing = Lighting:FindFirstChild(name)
    if existing then existing:Destroy() end
    local effect = Instance.new(className)
    effect.Name = name
    effect.Enabled = false
    effect.Parent = Lighting
    return effect
end

local TeleportBlur = CreateEffect("TeleportBlur", "BlurEffect")

-- == COLOR RESET FUNCTION ==
local function ResetVisualEffects()
    TeleportBlur.Enabled = false
    TeleportBlur.Size = 0
end

-- == VOID SCREEN GUI ==
local function CreateVoidScreen()
    local sg = Instance.new("ScreenGui")
    sg.Name = "VoidScreen"
    sg.IgnoreGuiInset = true
    sg.Parent = game:GetService("CoreGui")
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1.2, 0, 1.2, 0)
    frame.Position = UDim2.new(-0.1, 0, -0.1, 0)
    frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    frame.BackgroundTransparency = 1
    frame.BorderSizePixel = 0
    frame.Parent = sg
    return sg, frame
end

local function SaveWaypoints()
    if not hasFileFunctions then return end

    local saveableWaypoints = {}
    for _, wp in ipairs(Waypoints) do
        if wp and wp.Position then
            table.insert(saveableWaypoints, {
                Name = wp.Name,
                Position = {X = wp.Position.X, Y = wp.Position.Y, Z = wp.Position.Z}
            })
        end
    end

    local success, jsonData = pcall(HttpService.JSONEncode, HttpService, saveableWaypoints)
    if success then
        writefile(WaypointFilePath, jsonData)
    end
end

local function LoadWaypoints()
    if not hasFileFunctions or not isfile(WaypointFilePath) then return end

    local fileContent = readfile(WaypointFilePath)
    local success, loadedData = pcall(HttpService.JSONDecode, HttpService, fileContent)

    if success and type(loadedData) == "table" then
        local loadedWaypoints = {}
        for _, wpData in ipairs(loadedData) do
            if wpData and wpData.Name and wpData.Position then
                table.insert(loadedWaypoints, {
                    Name = wpData.Name,
                    Position = Vector3.new(wpData.Position.X, wpData.Position.Y, wpData.Position.Z)
                })
            end
        end
        Waypoints = loadedWaypoints
    end
end

-- == FIXED TELEPORT FUNCTION(NO MORE STUCK AVATAR) ==
local function TeleportTo(position)
    if IsTeleporting then return end
    IsTeleporting = true
    pcall(function()
        local character = LocalPlayer.Character
        if not character or not character:FindFirstChild("HumanoidRootPart") then return end
        local hrp = character.HumanoidRootPart
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if not humanoid then return end
        if IsViewing then StopViewing() end
        local targetPos = (typeof(position) == "Vector3") and position or Vector3.new(position.X, position.Y, position.Z)
        --Freeze before teleport
        hrp.Anchored = true
        hrp.AssemblyLinearVelocity = Vector3.zero
        humanoid:ChangeState(Enum.HumanoidStateType.Physics)
        local originalFOV = Camera.FieldOfView
        local voidGui, voidFrame = CreateVoidScreen()
        ResetVisualEffects()
        TeleportBlur.Enabled = true
        local sound = Instance.new("Sound")
        sound.SoundId = "rbxassetid://1840058567"
        sound.Volume = 1.5
        sound.Parent = workspace
        sound:Play()
        Debris:AddItem(sound, 3)
        local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Exponential, Enum.EasingDirection.In)
        TweenService:Create(Camera, tweenInfo, { FieldOfView = 150 }):Play()
        TweenService:Create(TeleportBlur, tweenInfo, { Size = 30 }):Play()
        TweenService:Create(voidFrame, tweenInfo, { BackgroundTransparency = 0 }):Play()
        task.wait(0.5)
        --Teleport
        hrp.CFrame = CFrame.new(targetPos + Vector3.new(0, 3, 0))
        Camera.FieldOfView = 10
        task.wait(0.2)
        --UNFREEZE FULLY(THIS IS THE FIX)
        hrp.Anchored = false
        hrp.AssemblyLinearVelocity = Vector3.zero
        hrp.AssemblyAngularVelocity = Vector3.zero
        humanoid.PlatformStand = false
        humanoid.Sit = false
        humanoid:ChangeState(Enum.HumanoidStateType.Running)
        task.wait()
        humanoid:ChangeState(Enum.HumanoidStateType.Freefall)
        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
        task.wait(0.05)
        humanoid:ChangeState(Enum.HumanoidStateType.Running)
        hrp.Velocity = Vector3.new(0, 50, 0) --Kick to break freeze
        task.wait(0.05)
        hrp.Velocity = Vector3.zero
        -- Exit animation
        local burstInfo = TweenInfo.new(0.7, Enum.EasingStyle.Elastic, Enum.EasingDirection.Out)
        local clearInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
        TweenService:Create(Camera, burstInfo, { FieldOfView = originalFOV }):Play()
        TweenService:Create(TeleportBlur, clearInfo, { Size = 0 }):Play()
        TweenService:Create(voidFrame, clearInfo, { BackgroundTransparency = 1 }):Play()
        local wave = Instance.new("Part")
        wave.Shape = Enum.PartType.Ball
        wave.Material = Enum.Material.Neon
        wave.Color = Color3.fromRGB(100, 255, 100)
        wave.CanCollide = false
        wave.Anchored = true
        wave.Size = Vector3.new(1, 1, 1)
        wave.Transparency = 0
        wave.Position = targetPos
        wave.Parent = workspace
        TweenService:Create(wave, TweenInfo.new(0.5), { Size = Vector3.new(25,25,25), Transparency = 1 }):Play()
        Debris:AddItem(wave, 0.6)
        local sound2 = Instance.new("Sound")
        sound2.SoundId = "rbxassetid://289556450"
        sound2.Volume = 0.8
        sound2.Parent = workspace
        sound2:Play()
        Debris:AddItem(sound2, 2)
        task.wait(0.6)
        voidGui:Destroy()
        ResetVisualEffects()
    end)
    IsTeleporting = false
end

-- [[ NEW SIMPLE VIEW SYSTEM STARTS HERE ]] --

function StopViewing()
    IsViewing = false

    -- 1. Disconnect the camera loop
    for _, connection in pairs(ViewConnections) do
        if connection then
            pcall(function() connection:Disconnect() end)
        end
    end
    ViewConnections = {}

    -- 2. Reset Camera to the Player
    workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        workspace.CurrentCamera.CameraSubject = LocalPlayer.Character.Humanoid
    end

    -- 3. Reset Button UI(If the button exists)
    if ViewButton then
        ViewButton.Text = "Satellite View"
        ViewButton.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    end
end

function ViewWaypoint(position)
    --If we are already viewing, stop first to prevent glitches
    if IsViewing then
        StopViewing()
        return
    end

    IsViewing = true

    -- 1. Safe Position Check
    local targetPos
    if typeof(position) == "Vector3" then
        targetPos = position
    elseif typeof(position) == "table" then
        targetPos = Vector3.new(position.X, position.Y, position.Z)
    else
        warn("Invalid Waypoint Position")
        StopViewing()
        return
    end

    -- 2. Update Button UI
    if ViewButton then
        ViewButton.Text = "Stop Viewing"
        ViewButton.BackgroundColor3 = Color3.fromRGB(150, 50, 50) --Red color
    end

    -- 3. Create a simple loop to lock the camera above the target
    -- We use RenderStepped to ensure the camera doesn't jitter
    local runServiceConnection = RunService.RenderStepped:Connect(function()
        if not IsViewing then return end

        -- Set camera to Scriptable so we can control it
        workspace.CurrentCamera.CameraType = Enum.CameraType.Scriptable

        -- Position: 80 studs directly above the target
        local cameraHeight = 80
        local camPos = targetPos + Vector3.new(0, cameraHeight, 0)

        --LookAt : Look directly down at the target
        workspace.CurrentCamera.CFrame = CFrame.new(camPos, targetPos)
    end)

    table.insert(ViewConnections, runServiceConnection)
end
-- [[ NEW SIMPLE VIEW SYSTEM ENDS HERE ]] --

--Create Waypoints UI matching Players tab design
local WaypointsContainer = Instance.new("Frame")
WaypointsContainer.Name = "WaypointsContainer"
WaypointsContainer.Size = UDim2.new(1, -20, 1, -10)
WaypointsContainer.Position = UDim2.new(0, 10, 0, 5)
WaypointsContainer.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
WaypointsContainer.BackgroundTransparency = 0
WaypointsContainer.BorderSizePixel = 0
WaypointsContainer.ZIndex = 5
WaypointsContainer.Parent = WaypointsPage.SubPage

-- Search Bar(matches Players tab)
local WaypointSearchBar = Instance.new("TextBox")
WaypointSearchBar.Size = UDim2.new(1, -20, 0, 35)
WaypointSearchBar.Position = UDim2.new(0, 10, 0, 10)
WaypointSearchBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
WaypointSearchBar.BorderSizePixel = 1
WaypointSearchBar.BorderColor3 = Color3.fromRGB(40, 40, 40)
WaypointSearchBar.Text = ""
WaypointSearchBar.PlaceholderText = "Search waypoints..."
WaypointSearchBar.TextColor3 = Color3.fromRGB(255, 255, 255)
WaypointSearchBar.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
WaypointSearchBar.Font = Enum.Font.Gotham
WaypointSearchBar.TextSize = 14
WaypointSearchBar.TextXAlignment = Enum.TextXAlignment.Left
WaypointSearchBar.ZIndex = 6
WaypointSearchBar.Parent = WaypointsContainer

local WaypointSPad = Instance.new("UIPadding")
WaypointSPad.PaddingLeft = UDim.new(0, 10)
WaypointSPad.Parent = WaypointSearchBar

-- Waypoint List(matches Players tab)
local WaypointList = Instance.new("ScrollingFrame")
WaypointList.Size = UDim2.new(1, -20, 0, 180)
WaypointList.Position = UDim2.new(0, 10, 0, 55)
WaypointList.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
WaypointList.BorderSizePixel = 1
WaypointList.BorderColor3 = Color3.fromRGB(40, 40, 40)
WaypointList.ScrollBarThickness = 4
WaypointList.ScrollBarImageColor3 = Color3.fromRGB(60, 60, 60)
WaypointList.ZIndex = 6
WaypointList.Parent = WaypointsContainer

local WaypointListLayout = Instance.new("UIListLayout")
WaypointListLayout.SortOrder = Enum.SortOrder.Name
WaypointListLayout.Parent = WaypointList

-- Info Area(matches Players tab) - MOVED UP TO ALLOW ROOM FOR BUTTONS
local WaypointInfoArea = Instance.new("Frame")
WaypointInfoArea.Size = UDim2.new(1, -20, 0, 110)
WaypointInfoArea.Position = UDim2.new(0, 10, 0, 240)
WaypointInfoArea.BackgroundTransparency = 1
WaypointInfoArea.ZIndex = 6
WaypointInfoArea.Parent = WaypointsContainer

-- Name Input Area(NOW EDITABLE)
local NameInputArea = Instance.new("Frame")
NameInputArea.Size = UDim2.new(1, 0, 0, 60)
NameInputArea.Position = UDim2.new(0, 0, 0, 0)
NameInputArea.BackgroundTransparency = 1
NameInputArea.ZIndex = 7
NameInputArea.Parent = WaypointInfoArea

local NameLabel = Instance.new("TextLabel")
NameLabel.Size = UDim2.new(0, 120, 0, 20)
NameLabel.Position = UDim2.new(0, 0, 0, 0)
NameLabel.BackgroundTransparency = 1
NameLabel.Text = "Waypoint Name"
NameLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
NameLabel.Font = Enum.Font.Gotham
NameLabel.TextSize = 12
NameLabel.TextXAlignment = Enum.TextXAlignment.Left
NameLabel.ZIndex = 7
NameLabel.Parent = NameInputArea

local NameInput = Instance.new("TextBox")
NameInput.Size = UDim2.new(1, 0, 0, 30)
NameInput.Position = UDim2.new(0, 0, 0, 25)
NameInput.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
NameInput.BorderSizePixel = 1
NameInput.BorderColor3 = Color3.fromRGB(40, 40, 40)
NameInput.Text = ""
NameInput.TextColor3 = Color3.fromRGB(255, 255, 255)
NameInput.Font = Enum.Font.Gotham
NameInput.TextSize = 12
NameInput.ZIndex = 7
NameInput.Parent = NameInputArea

NameInput.Focused:Connect(function()
    if SelectedWaypoint then
        SelectedWaypoint = nil
        NameInput:ReleaseFocus()
        _G.UpdateWaypointInfo()
        _G.UpdateWaypointList()
    end
end)

NameInput.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 and SelectedWaypoint then
        SelectedWaypoint = nil
        _G.UpdateWaypointInfo()
        _G.UpdateWaypointList()
    end
end)

local NamePad = Instance.new("UIPadding")
NamePad.PaddingLeft = UDim.new(0, 8)
NamePad.Parent = NameInput

local CoordsLabel = Instance.new("TextLabel")
CoordsLabel.Size = UDim2.new(1, 0, 0, 20)
CoordsLabel.Position = UDim2.new(0, 0, 0, 65)
CoordsLabel.BackgroundTransparency = 1
CoordsLabel.Text = ""
CoordsLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
CoordsLabel.Font = Enum.Font.Gotham
CoordsLabel.TextSize = 12
CoordsLabel.TextXAlignment = Enum.TextXAlignment.Left
CoordsLabel.ZIndex = 7
CoordsLabel.Parent = WaypointInfoArea

-- Buttons Area(matches Players tab layout) - MOVED DOWN TO ALLOW SCROLLING
local WaypointButtonsArea = Instance.new("Frame")
WaypointButtonsArea.Name = "ButtonsArea"
WaypointButtonsArea.Size = UDim2.new(1, -20, 0, 70)
WaypointButtonsArea.Position = UDim2.new(0, 10, 0, 365)
WaypointButtonsArea.BackgroundTransparency = 1
WaypointButtonsArea.ZIndex = 6
WaypointButtonsArea.Parent = WaypointsContainer

local buttonWidth = 110
local buttonHeight = 30
local spacing = 10

--First row of buttons
local WaypointTeleportBtn = Instance.new("TextButton")
WaypointTeleportBtn.Size = UDim2.new(0, buttonWidth, 0, buttonHeight)
WaypointTeleportBtn.Position = UDim2.new(0, 0, 0, 0)
WaypointTeleportBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
WaypointTeleportBtn.BorderColor3 = Color3.fromRGB(40, 40, 40)
WaypointTeleportBtn.BorderSizePixel = 1
WaypointTeleportBtn.Text = "Teleport"
WaypointTeleportBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
WaypointTeleportBtn.Font = Enum.Font.Gotham
WaypointTeleportBtn.TextSize = 12
WaypointTeleportBtn.ZIndex = 7
WaypointTeleportBtn.Parent = WaypointButtonsArea

ViewButton = Instance.new("TextButton")
ViewButton.Size = UDim2.new(0, buttonWidth, 0, buttonHeight)
ViewButton.Position = UDim2.new(0, buttonWidth + spacing, 0, 0)
ViewButton.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
ViewButton.BorderColor3 = Color3.fromRGB(40, 40, 40)
ViewButton.BorderSizePixel = 1
ViewButton.Text = "Satellite View"
ViewButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ViewButton.Font = Enum.Font.Gotham
ViewButton.TextSize = 12
ViewButton.ZIndex = 7
ViewButton.Parent = WaypointButtonsArea

local WaypointDeleteBtn = Instance.new("TextButton")
WaypointDeleteBtn.Size = UDim2.new(0, buttonWidth, 0, buttonHeight)
WaypointDeleteBtn.Position = UDim2.new(0, (buttonWidth + spacing) * 2, 0, 0)
WaypointDeleteBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
WaypointDeleteBtn.BorderColor3 = Color3.fromRGB(40, 40, 40)
WaypointDeleteBtn.BorderSizePixel = 1
WaypointDeleteBtn.Text = "Delete"
WaypointDeleteBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
WaypointDeleteBtn.Font = Enum.Font.Gotham
WaypointDeleteBtn.TextSize = 12
WaypointDeleteBtn.ZIndex = 7
WaypointDeleteBtn.Parent = WaypointButtonsArea

-- Second row of buttons
local WaypointSavePosBtn = Instance.new("TextButton")
WaypointSavePosBtn.Size = UDim2.new(0, buttonWidth, 0, buttonHeight)
WaypointSavePosBtn.Position = UDim2.new(0, 0, 0, buttonHeight + spacing)
WaypointSavePosBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
WaypointSavePosBtn.BorderColor3 = Color3.fromRGB(40, 40, 40)
WaypointSavePosBtn.BorderSizePixel = 1
WaypointSavePosBtn.Text = "Save Pos"
WaypointSavePosBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
WaypointSavePosBtn.Font = Enum.Font.Gotham
WaypointSavePosBtn.TextSize = 12
WaypointSavePosBtn.ZIndex = 7
WaypointSavePosBtn.Parent = WaypointButtonsArea

local WaypointAddBtn = Instance.new("TextButton")
WaypointAddBtn.Size = UDim2.new(0, buttonWidth, 0, buttonHeight)
WaypointAddBtn.Position = UDim2.new(0, buttonWidth + spacing, 0, buttonHeight + spacing)
WaypointAddBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
WaypointAddBtn.BorderColor3 = Color3.fromRGB(40, 40, 40)
WaypointAddBtn.BorderSizePixel = 1
WaypointAddBtn.Text = "Add Waypoint"
WaypointAddBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
WaypointAddBtn.Font = Enum.Font.Gotham
WaypointAddBtn.TextSize = 12
WaypointAddBtn.ZIndex = 7
WaypointAddBtn.Parent = WaypointButtonsArea

local WaypointCopyCoordsBtn = Instance.new("TextButton")
WaypointCopyCoordsBtn.Size = UDim2.new(0, buttonWidth, 0, buttonHeight)
WaypointCopyCoordsBtn.Position = UDim2.new(0, (buttonWidth + spacing) * 2, 0, buttonHeight + spacing)
WaypointCopyCoordsBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
WaypointCopyCoordsBtn.BorderColor3 = Color3.fromRGB(40, 40, 40)
WaypointCopyCoordsBtn.BorderSizePixel = 1
WaypointCopyCoordsBtn.Text = "Copy Coords"
WaypointCopyCoordsBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
WaypointCopyCoordsBtn.Font = Enum.Font.Gotham
WaypointCopyCoordsBtn.TextSize = 12
WaypointCopyCoordsBtn.ZIndex = 7
WaypointCopyCoordsBtn.Parent = WaypointButtonsArea

-- Update info function(matches Players tab selection style)
_G.UpdateWaypointInfo = function()
    if SelectedWaypoint and Waypoints[SelectedWaypoint] then
        local wp = Waypoints[SelectedWaypoint]
        NameInput.Text = wp.Name
        CoordsLabel.Text = string.format("Coordinates: %.0f, %.0f, %.0f", wp.Position.X, wp.Position.Y, wp.Position.Z)
    else
        NameInput.Text = ""
        CoordsLabel.Text = ""
    end
end

-- Button functionality
WaypointTeleportBtn.MouseButton1Click:Connect(function()
    if SelectedWaypoint and Waypoints[SelectedWaypoint] then
        TeleportTo(Waypoints[SelectedWaypoint].Position)
    end
end)

ViewButton.MouseButton1Click:Connect(function()
    if SelectedWaypoint and Waypoints[SelectedWaypoint] then
        ViewWaypoint(Waypoints[SelectedWaypoint].Position)
    end
end)

WaypointDeleteBtn.MouseButton1Click:Connect(function()
    if SelectedWaypoint then
        table.remove(Waypoints, SelectedWaypoint)
        SelectedWaypoint = nil
        _G.UpdateWaypointInfo()
        _G.UpdateWaypointList()
        SaveWaypoints()
    end
end)

WaypointSavePosBtn.MouseButton1Click:Connect(function()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        local p = char.HumanoidRootPart.Position
        if SelectedWaypoint and Waypoints[SelectedWaypoint] then
            -- Update existing waypoint position
            Waypoints[SelectedWaypoint].Position = p
            _G.UpdateWaypointInfo()
            _G.UpdateWaypointList()
            SaveWaypoints()
        else
            --Just show current position in coords label
            CoordsLabel.Text = string.format("Current Position: %.0f, %.0f, %.0f", p.X, p.Y, p.Z)
        end
    end
end)

WaypointAddBtn.MouseButton1Click:Connect(function()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        local p = char.HumanoidRootPart.Position
        local waypointName = NameInput.Text ~= "" and NameInput.Text or ("Waypoint_" .. (#Waypoints + 1))

        local waypointData = {
            Name = waypointName,
            Position = p
        }
        table.insert(Waypoints, waypointData)
        SelectedWaypoint = #Waypoints
        _G.UpdateWaypointInfo()
        _G.UpdateWaypointList()
        SaveWaypoints()
    end
end)

WaypointCopyCoordsBtn.MouseButton1Click:Connect(function()
    if SelectedWaypoint and Waypoints[SelectedWaypoint] then
        local coords = string.format("%.0f, %.0f, %.0f",
            Waypoints[SelectedWaypoint].Position.X,
            Waypoints[SelectedWaypoint].Position.Y,
            Waypoints[SelectedWaypoint].Position.Z)
        setclipboard(coords)
    end
end)

--Update waypoint list function(matches Players tab selection style)
_G.UpdateWaypointList = function()
    if not WaypointList then return end

    for _, v in pairs(WaypointList:GetChildren()) do
        if v:IsA("Frame") then v:Destroy() end
    end

    local filter = (WaypointSearchBar and WaypointSearchBar.Text) and WaypointSearchBar.Text:lower() or ""
    for i, wp in pairs(Waypoints) do
        if wp and wp.Name and wp.Position then
            if filter == "" or wp.Name:lower():find(filter) then
                local Row = Instance.new("Frame")
                Row.Size = UDim2.new(1, 0, 0, 25)
                Row.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
                Row.BorderSizePixel = 0
                Row.ZIndex = 7
                Row.Parent = WaypointList

                -- Clickable area for selection(no button needed)
                local Btn = Instance.new("TextButton")
                Btn.Size = UDim2.new(1, 0, 1, 0)
                Btn.BackgroundTransparency = 1
                Btn.Text = ""
                Btn.ZIndex = 8
                Btn.Parent = Row

                local NameT = Instance.new("TextLabel")
                NameT.Text = wp.Name
                NameT.Size = UDim2.new(0.5, 0, 1, 0)
                NameT.Position = UDim2.new(0, 5, 0, 0)
                NameT.BackgroundTransparency = 1

                --WHITE when not selected, GREEN when selected
                if SelectedWaypoint == i then
                    NameT.TextColor3 = Color3.fromRGB(100, 255, 100) --Green when selected
                    Row.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
                else
                    NameT.TextColor3 = Color3.fromRGB(255, 255, 255) --White when not selected
                end

                NameT.TextXAlignment = Enum.TextXAlignment.Left
                NameT.Font = Enum.Font.Gotham
                NameT.TextSize = 12
                NameT.ZIndex = 8
                NameT.Parent = Row

                local CoordsT = Instance.new("TextLabel")
                CoordsT.Text = string.format("%.0f, %.0f, %.0f", wp.Position.X, wp.Position.Y, wp.Position.Z)
                CoordsT.Size = UDim2.new(0.3, 0, 1, 0)
                CoordsT.Position = UDim2.new(0.5, 0, 0, 0)
                CoordsT.BackgroundTransparency = 1
                CoordsT.TextColor3 = Color3.fromRGB(150, 150, 150)
                CoordsT.Font = Enum.Font.Gotham
                CoordsT.TextSize = 11
                CoordsT.ZIndex = 8
                CoordsT.Parent = Row

                local TypeT = Instance.new("TextLabel")
                TypeT.Text = "Waypoint"
                TypeT.Size = UDim2.new(0.2, 0, 1, 0)
                TypeT.Position = UDim2.new(0.8, 0, 0, 0)
                TypeT.BackgroundTransparency = 1
                TypeT.TextColor3 = Color3.fromRGB(100, 200, 100)
                TypeT.Font = Enum.Font.Gotham
                TypeT.TextSize = 11
                TypeT.ZIndex = 8
                TypeT.Parent = Row

                Btn.MouseButton1Click:Connect(function()
                    SelectedWaypoint = i
                    _G.UpdateWaypointInfo()
                    _G.UpdateWaypointList()
                end)
            end
        end
    end

    task.spawn(function()
        task.wait(0.1)
        if WaypointListLayout and WaypointList then
            WaypointList.CanvasSize = UDim2.new(0, 0, 0, WaypointListLayout.AbsoluteContentSize.Y)
        end
    end)
end

-- Initialize waypoint list
task.spawn(function()
    task.wait(0.5)
    LoadWaypoints()
    if _G.UpdateWaypointList then
        _G.UpdateWaypointList()
    end
end)

if WaypointSearchBar then
    WaypointSearchBar:GetPropertyChangedSignal("Text"):Connect(function()
        if _G.UpdateWaypointList then
            _G.UpdateWaypointList()
        end
    end)
end

-- ESC key to exit view mode
UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.Escape and IsViewing then
        StopViewing()
    end
end)

--Update info initially
_G.UpdateWaypointInfo()

--Initialize waypoint list
_G.UpdateWaypointList()


-- [[ NEW CONFIG SYSTEM AND THEMES ]] --
-- Helper: Recursively updates settings table without breaking references
local function UpdateTable(target, source)
    for k, v in pairs(source) do
        if type(v) == "table" and type(target[k]) == "table" then
            UpdateTable(target[k], v)
        else
            target[k] = v
        end
    end
end

local SettingsTab = Window:Tab("Settings")
local SetMain = SettingsTab:SubTab("Configs")
SetMain.SubPage.ScrollingEnabled = false

-- Container for the config UI
local CfgContainer = Instance.new("Frame")
CfgContainer.Size = UDim2.new(1, -20, 0.55, 0) -- Adjusted height to fit Theme below
CfgContainer.Position = UDim2.new(0, 10, 0, 10)
CfgContainer.BackgroundTransparency = 1
CfgContainer.Parent = SetMain.SubPage

-- Input Box for Config Name
local ConfigName = Instance.new("TextBox")
ConfigName.Size = UDim2.new(1, 0, 0, 30)
ConfigName.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
ConfigName.Text = ""
ConfigName.PlaceholderText = "Config Name..."
ConfigName.TextColor3 = Color3.fromRGB(255, 255, 255)
ConfigName.Font = Enum.Font.Gotham
ConfigName.TextSize = 12
ConfigName.Parent = CfgContainer
local ConfigStroke = Instance.new("UIStroke")
ConfigStroke.Color = UIConfig.Outline
ConfigStroke.Parent = ConfigName

-- Scrolling List for Saved Configs
local ConfigList = Instance.new("ScrollingFrame")
ConfigList.Size = UDim2.new(1, 0, 1, -80)
ConfigList.Position = UDim2.new(0, 0, 0, 40)
ConfigList.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
ConfigList.ScrollBarThickness = 4
ConfigList.BorderColor3 = UIConfig.Outline
ConfigList.Parent = CfgContainer
local CfgLayout = Instance.new("UIListLayout")
CfgLayout.Parent = ConfigList

-- Container for Buttons (Save/Load/Delete)
local CfgBtns = Instance.new("Frame")
CfgBtns.Size = UDim2.new(1, 0, 0, 30)
CfgBtns.Position = UDim2.new(0, 0, 1, -30)
CfgBtns.BackgroundTransparency = 1
CfgBtns.Parent = CfgContainer

-- [[ CONFIG LOGIC FUNCTIONS ]] --
local function RefreshConfigs()
    -- Clear existing buttons
    for _, v in pairs(ConfigList:GetChildren()) do 
        if v:IsA("TextButton") then v:Destroy() end 
    end

    if hasFileFunctions then
        local files = listfiles("NerdWare")
        for _, file in ipairs(files) do
            -- Extract file name from path
            local name = file:match("NerdWare/(.*).json")
            if name then
                local btn = Instance.new("TextButton")
                btn.Size = UDim2.new(1, 0, 0, 25)
                btn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
                btn.Text = name
                btn.TextColor3 = Color3.fromRGB(200, 200, 200)
                btn.Font = Enum.Font.Gotham
                btn.TextSize = 12
                btn.Parent = ConfigList
                
                -- clicking a file sets the text box name
                btn.MouseButton1Click:Connect(function() 
                    ConfigName.Text = name 
                end)
            end
        end
    end
    -- Adjust scroll size
    ConfigList.CanvasSize = UDim2.new(0, 0, 0, CfgLayout.AbsoluteContentSize.Y)
end

-- SAVE BUTTON
local SaveBtn = Instance.new("TextButton")
SaveBtn.Size = UDim2.new(0.3, 0, 1, 0)
SaveBtn.BackgroundColor3 = Color3.fromRGB(100, 200, 100) -- Green/Accent
SaveBtn.Text = "Save"
SaveBtn.Font = Enum.Font.Gotham
SaveBtn.TextSize = 12
SaveBtn.Parent = CfgBtns

SaveBtn.MouseButton1Click:Connect(function()
    local name = ConfigName.Text
    if name == "" then return end
    if hasFileFunctions then
        -- Encode the global settings table to JSON
        local json = HttpService:JSONEncode(_G.Settings)
        writefile("NerdWare/" .. name .. ".json", json)
        RefreshConfigs()
    end
end)

-- LOAD BUTTON
local LoadBtn = Instance.new("TextButton")
LoadBtn.Size = UDim2.new(0.3, 0, 1, 0)
LoadBtn.Position = UDim2.new(0.35, 0, 0, 0)
LoadBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
LoadBtn.Text = "Load"
LoadBtn.TextColor3 = Color3.new(1,1,1)
LoadBtn.Font = Enum.Font.Gotham
LoadBtn.TextSize = 12
LoadBtn.Parent = CfgBtns

LoadBtn.MouseButton1Click:Connect(function()
    local name = ConfigName.Text
    if name == "" then return end
    
    if hasFileFunctions and isfile("NerdWare/" .. name .. ".json") then
        local content = readfile("NerdWare/" .. name .. ".json")
        local success, data = pcall(function() return HttpService:JSONDecode(content) end)
        
        if success then
            -- 1. Merge Loaded Data into Settings
            UpdateTable(_G.Settings, data)
            
            -- 2. Force UI Visual Refresh
            for _, func in ipairs(_G.ConfigUpdateFunctions) do 
                pcall(func) 
            end
            
            -- 3. Refresh Waypoint List specifically
            if _G.UpdateWaypointList then _G.UpdateWaypointList() end
            
            print("Config loaded successfully!")
        end
    end
end)

-- DELETE BUTTON
local DelBtn = Instance.new("TextButton")
DelBtn.Size = UDim2.new(0.3, 0, 1, 0)
DelBtn.Position = UDim2.new(0.7, 0, 0, 0)
DelBtn.BackgroundColor3 = Color3.fromRGB(150, 50, 50) -- Red
DelBtn.Text = "Delete"
DelBtn.TextColor3 = Color3.new(1,1,1)
DelBtn.Font = Enum.Font.Gotham
DelBtn.TextSize = 12
DelBtn.Parent = CfgBtns

DelBtn.MouseButton1Click:Connect(function()
    local name = ConfigName.Text
    if name == "" then return end
    
    if hasFileFunctions and isfile("NerdWare/" .. name .. ".json") then
        delfile("NerdWare/" .. name .. ".json")
        RefreshConfigs()
        ConfigName.Text = ""
    end
end)

-- Initial Refresh to show files on load
RefreshConfigs()


-- [[ THEMES SECTION ]] --
-- Preserved from original script, repositioned below new config system

local ThemesContainer = Instance.new("Frame")
ThemesContainer.Name = "ThemesContainer"
ThemesContainer.Size = UDim2.new(1, -20, 0.35, 0)
ThemesContainer.Position = UDim2.new(0, 10, 0.62, 0)
ThemesContainer.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
ThemesContainer.BackgroundTransparency = 0
ThemesContainer.BorderSizePixel = 0
ThemesContainer.ZIndex = 5
ThemesContainer.Parent = SetMain.SubPage

local ThemesStroke = Instance.new("UIStroke")
ThemesStroke.Color = UIConfig.Outline
ThemesStroke.Parent = ThemesContainer

local ThemesAccent = Instance.new("Frame")
ThemesAccent.Size = UDim2.new(1, 0, 0, 1)
ThemesAccent.BackgroundColor3 = UIConfig.Accent
ThemesAccent.BorderSizePixel = 0
ThemesAccent.ZIndex = 6
ThemesAccent.Parent = ThemesContainer
local ThemesAccentGradient = Instance.new("UIGradient")
ThemesAccentGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, UIConfig.Accent),
    ColorSequenceKeypoint.new(1, UIConfig.SectionColor)
}
ThemesAccentGradient.Parent = ThemesAccent

-- Register theme container lines
table.insert(ThemeUpdateFunctions, function()
    ThemesAccent.BackgroundColor3 = UIConfig.Accent
    ThemesAccentGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, UIConfig.Accent),
        ColorSequenceKeypoint.new(1, UIConfig.SectionColor)
    }
end)

local ThemeTitle = Instance.new("TextLabel")
ThemeTitle.Size = UDim2.new(1, -20, 0, 20)
ThemeTitle.Position = UDim2.new(0, 10, 0, 0)
ThemeTitle.BackgroundTransparency = 1
ThemeTitle.Text = "Themes"
ThemeTitle.TextColor3 = UIConfig.Text
ThemeTitle.Font = UIConfig.Font
ThemeTitle.TextSize = 12
ThemeTitle.TextXAlignment = Enum.TextXAlignment.Left
ThemeTitle.ZIndex = 6
ThemeTitle.Parent = ThemesContainer

local Defaults = {
    Accent = UIConfig.Accent,
    Outline = UIConfig.Outline,
    Text = UIConfig.Text,
    MainColor = UIConfig.MainColor,
    SecondaryColor = UIConfig.SecondaryColor,
    SectionColor = UIConfig.SectionColor
}

local PresetLabel = Instance.new("TextLabel")
PresetLabel.Size = UDim2.new(1, -20, 0, 20)
PresetLabel.Position = UDim2.new(0, 10, 0, 22)
PresetLabel.BackgroundTransparency = 1
PresetLabel.Text = "Preset"
PresetLabel.TextColor3 = UIConfig.Text
PresetLabel.Font = UIConfig.Font
PresetLabel.TextSize = 12
PresetLabel.TextXAlignment = Enum.TextXAlignment.Left
PresetLabel.ZIndex = 6
PresetLabel.Parent = ThemesContainer

local ThemeDrop = Instance.new("TextButton")
ThemeDrop.Size = UDim2.new(1, -20, 0, 25)
ThemeDrop.Position = UDim2.new(0, 10, 0, 42)
ThemeDrop.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
ThemeDrop.Text = " Default"
ThemeDrop.TextColor3 = UIConfig.Text
ThemeDrop.Font = UIConfig.Font
ThemeDrop.TextSize = 12
ThemeDrop.TextXAlignment = Enum.TextXAlignment.Left
ThemeDrop.BorderSizePixel = 0
ThemeDrop.ZIndex = 6
ThemeDrop.Parent = ThemesContainer

local ThemeDropStroke = Instance.new("UIStroke")
ThemeDropStroke.Color = UIConfig.Outline
ThemeDropStroke.Parent = ThemeDrop

-- Function to update all UI elements with the current theme
function UpdateAllThemes()
    for _, updateFunc in ipairs(ThemeUpdateFunctions) do
        pcall(updateFunc)
    end
end

-- Function to apply themes
local function applyTheme(name)
    if name == "Default" then
        UIConfig.Accent = Defaults.Accent
        UIConfig.Outline = Defaults.Outline
        UIConfig.Text = Defaults.Text
        UIConfig.MainColor = Defaults.MainColor
        UIConfig.SecondaryColor = Defaults.SecondaryColor
        UIConfig.SectionColor = Defaults.SectionColor

        if _G.LogoIconRef then
            _G.LogoIconRef.Image = "rbxthumb://type=Asset&id=73884793344716&w=420&h=420"
            _G.LogoIconRef.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
        end
    elseif name == "Purple" then
        UIConfig.Accent = Color3.fromRGB(170, 0, 255)
        UIConfig.Outline = Defaults.Outline
        UIConfig.Text = Defaults.Text
        UIConfig.MainColor = Defaults.MainColor
        UIConfig.SecondaryColor = Defaults.SecondaryColor
        UIConfig.SectionColor = Defaults.SectionColor

        if _G.LogoIconRef then
            _G.LogoIconRef.Image = "rbxthumb://type=Asset&id=99103066865338&w=420&h=420"
            _G.LogoIconRef.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
        end
    elseif name == "Red" then
        UIConfig.Accent = Color3.fromRGB(139, 0, 0) -- Dark red
        UIConfig.Outline = Defaults.Outline
        UIConfig.Text = Defaults.Text
        UIConfig.MainColor = Defaults.MainColor
        UIConfig.SecondaryColor = Defaults.SecondaryColor
        UIConfig.SectionColor = Defaults.SectionColor

        if _G.LogoIconRef then
            _G.LogoIconRef.Image = "rbxthumb://type=Asset&id=101325866946084&w=420&h=420"
            _G.LogoIconRef.BackgroundColor3 = Color3.fromRGB(0, 0, 0)

            -- Error handling if image fails
            _G.LogoIconRef:GetPropertyChangedSignal("Image"):Connect(function()
                if _G.LogoIconRef.Image == "" then
                    warn("Failed to load Red theme logo!")
                    _G.LogoIconRef.Image = "rbxthumb://type=Asset&id=73884793344716&w=420&h=420"
                end
            end)
        end
    end

    UpdateAllThemes()
end

local themeOrder = { "Default", "Purple", "Red" }
local themeIndex = 1

ThemeDrop.MouseButton1Click:Connect(function()
    themeIndex = (themeIndex % #themeOrder) + 1
    local name = themeOrder[themeIndex]
    ThemeDrop.Text = " " ..name
    applyTheme(name)
end)

-- Main game loop
RunService.RenderStepped:Connect(function()
    if _G.Settings.Aimbot.Enabled and UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) then
        local closest, dist = nil, math.huge
        local mousePos = UserInputService:GetMouseLocation()
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild(_G.Settings.Aimbot.AimPart) then
                local part = p.Character[_G.Settings.Aimbot.AimPart]
                local pos, onScreen = Camera:WorldToViewportPoint(part.Position)
                if onScreen then
                    local mag = (Vector2.new(pos.X, pos.Y) - mousePos).Magnitude
                    if mag < dist then closest = part; dist = mag end
                end
            end
        end
        if closest then
            local lookAt = CFrame.new(Camera.CFrame.Position, closest.Position)
            local smoothValue = _G.Settings.Aimbot.Smoothness
            local lerpAlpha = _G.Settings.Smoothness.Enabled and smoothValue or 1.0
            Camera.CFrame = Camera.CFrame:Lerp(lookAt, lerpAlpha)
        end
    end

    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        if _G.Settings.Player.WalkSpeed > 16 then LocalPlayer.Character.Humanoid.WalkSpeed = _G.Settings.Player.WalkSpeed end
        if _G.Settings.Player.JumpPower > 50 then LocalPlayer.Character.Humanoid.JumpPower = _G.Settings.Player.JumpPower end
    end
end)

print("NerdWare V7 Loaded - Config System & Themes Active")
